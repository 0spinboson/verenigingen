zabbix_export:
  version: '7.2'
  template_groups:
    - uuid: 38b195f7-c419-4c44-b956-4509523982e6
      name: Frappe Applications
  templates:
    - uuid: f689a768-4da6-4cd4-962c-03b041b0e36f
      template: Template Frappe Cloud Monitoring
      name: Template Frappe Cloud Monitoring
      description: Monitor Frappe/ERPNext applications including Verenigingen - Zabbix 7.2 Compatible
      vendor:
        name: Verenigingen
        version: '7.0'
      groups:
        - name: Frappe Applications
      items:
        # Health Check
        - uuid: 231d4b9d-e39a-46cd-996b-6412d2031c27
          name: Frappe Health Status
          type: HTTP_AGENT
          key: frappe.health.status
          delay: 1m
          history: 7d
          trends: '0'
          value_type: TEXT
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.health_check'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
            - name: Content-Type
              value: 'application/json'
            - name: Accept
              value: 'application/json'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.status
              error_handler: CUSTOM_VALUE
              error_handler_params: 'unhealthy'
          triggers:
            - uuid: 65bd2f96-7aff-42bb-91f5-02e8e547dc76
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.health.status)<>"healthy"'
              name: 'Frappe application is unhealthy'
              priority: HIGH
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: availability

        # Member Metrics
        - uuid: d014f27f-5a13-4f00-9efd-0481f387c83a
          name: Active Members Count
          type: HTTP_AGENT
          key: frappe.members.active
          delay: 5m
          history: 30d
          trends: 365d
          value_type: UNSIGNED
          units: members
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.active_members
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 30m
          tags:
            - tag: component
              value: members

        # Financial Metrics
        - uuid: 95306fd7-766f-4ebf-9e2c-0b7de67eec3f
          name: Daily Donations Total
          type: HTTP_AGENT
          key: frappe.donations.today
          delay: 5m
          history: 90d
          trends: 365d
          value_type: FLOAT
          units: EUR
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.donations.today\"]"
            - type: MULTIPLIER
              parameters:
                - '1'
          tags:
            - tag: component
              value: financial

        # Performance Metrics
        - uuid: f55c0da1-469d-4d85-93ce-3363075ee33a
          name: Error Rate
          type: HTTP_AGENT
          key: frappe.error.rate
          delay: 1m
          history: 7d
          trends: 30d
          value_type: FLOAT
          units: '%'
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.error_rate
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 5m
          triggers:
            - uuid: 858b2cb0-f6fb-49e6-a0e6-d96e56e9d91e
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.error.rate)>{$ERROR_RATE_WARN}'
              name: 'High error rate on Frappe application'
              event_name: 'Error rate: {ITEM.VALUE}%'
              priority: WARNING
              dependencies:
                - name: 'Frappe application is unhealthy'
                  expression: 'last(/Template Frappe Cloud Monitoring/frappe.health.status)<>"healthy"'
              tags:
                - tag: scope
                  value: performance
            - uuid: 206db5c7-e5cb-46d9-887c-dc6fc18e5b7c
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.error.rate)>{$ERROR_RATE_HIGH}'
              name: 'Critical error rate on Frappe application'
              event_name: 'Critical error rate: {ITEM.VALUE}%'
              priority: HIGH
              tags:
                - tag: scope
                  value: performance

        # Response Time
        - uuid: e4b91100-6ee9-43e0-bd5f-5a119304ad9c
          name: Average Response Time
          type: HTTP_AGENT
          key: frappe.response.time
          delay: 1m
          history: 7d
          trends: 30d
          value_type: UNSIGNED
          units: ms
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.response_time
          triggers:
            - uuid: 8b7ad39b-6705-4c96-90b5-6c1b46cbe564
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.response.time)>{$RESPONSE_TIME_WARN}'
              name: 'Slow response time on Frappe application'
              event_name: 'Response time: {ITEM.VALUE}ms'
              priority: WARNING
              tags:
                - tag: scope
                  value: performance

        # System Health Score
        - uuid: 825b23a3-e23f-4a08-b6a6-adba6e140dfd
          name: System Health Score
          type: HTTP_AGENT
          key: frappe.health.score
          delay: 5m
          history: 7d
          trends: 30d
          value_type: UNSIGNED
          units: '%'
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.system_health
            - type: IN_RANGE
              parameters:
                - '0'
                - '100'
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          triggers:
            - uuid: f89470c8-c3d6-4afe-9bc3-e1a33bd40acb
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.health.score)<50'
              name: 'Low system health score'
              event_name: 'Health score: {ITEM.VALUE}%'
              priority: HIGH
              tags:
                - tag: scope
                  value: availability

        # Business Metrics
        - uuid: 680e4ed9-9c4c-4a69-9958-91c17d511f2d
          name: Pending Volunteer Expenses
          type: HTTP_AGENT
          key: frappe.expenses.pending
          delay: 5m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.pending_expenses
          tags:
            - tag: component
              value: volunteer

        # Worker Status
        - uuid: ef8f18aa-1978-4d18-9f39-c1b1d765abe5
          name: Background Jobs Queue Size
          type: HTTP_AGENT
          key: frappe.jobs.queue
          delay: 1m
          history: 7d
          trends: 30d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.job_queue_size
          triggers:
            - uuid: 93c88f9c-5857-4e94-ae02-98570338788d
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.jobs.queue)>100'
              name: 'Large job queue backlog'
              priority: WARNING
              tags:
                - tag: scope
                  value: performance

        # Database Connections
        - uuid: 9470d0ea-34b1-4ae1-be13-334e1a79ac32
          name: Database Connections
          type: HTTP_AGENT
          key: frappe.db.connections
          delay: 1m
          history: 7d
          trends: 30d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.message.metrics.db_connections
          triggers:
            - uuid: cd0619e9-41b9-4ca7-8c55-f86ab1bfd51a
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.db.connections)>80'
              name: 'High database connection usage'
              priority: WARNING
              tags:
                - tag: scope
                  value: resource

        # New Business Metrics
        - uuid: b53240cb-899d-4245-8398-ab5b9e8152f1
          name: Member Total Count
          type: HTTP_AGENT
          key: frappe.members.total
          delay: 5m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.members.total\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        - uuid: 5cd3248a-e234-453d-8c21-d01919a0c9e1
          name: Member Churn Rate
          type: HTTP_AGENT
          key: frappe.member.churn_rate
          delay: 1h
          history: 30d
          trends: 90d
          value_type: FLOAT
          units: '%'
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.member.churn_rate\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          triggers:
            - uuid: 7666e74b-9f34-4c4f-8d96-a1d1fe96fd12
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.member.churn_rate)>{$CHURN_RATE_WARN}'
              name: 'High member churn rate'
              priority: WARNING
              tags:
                - tag: scope
                  value: business

        - uuid: 9e241973-80ee-4d75-983c-929674d822f5
          name: Active Volunteers
          type: HTTP_AGENT
          key: frappe.volunteers.active
          delay: 5m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.volunteers.active\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        - uuid: 59cf8cd8-71f7-4d6f-96c5-9929105ad44b
          name: Volunteer Engagement Rate
          type: HTTP_AGENT
          key: frappe.volunteer.engagement
          delay: 1h
          history: 30d
          trends: 90d
          value_type: FLOAT
          units: '%'
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.volunteer.engagement\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        # Financial Metrics
        - uuid: fb41d713-c395-4b1b-a9f8-754f2321ea7e
          name: Sales Invoices Today
          type: HTTP_AGENT
          key: frappe.invoices.sales_today
          delay: 10m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.invoices.sales_today\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        - uuid: 2ee405f6-c81c-41bb-98dc-35de77b7d99f
          name: Subscription Invoices Today
          type: HTTP_AGENT
          key: frappe.invoices.subscription_today
          delay: 10m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.invoices.subscription_today\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        - uuid: 8a15a7fb-d943-4ee0-9aa0-563e2766428a
          name: Total Invoices Today
          type: HTTP_AGENT
          key: frappe.invoices.total_today
          delay: 10m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.invoices.total_today\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        # Subscription Metrics
        - uuid: ffe1ea0a-7e6f-466a-954c-b2908ada337e
          name: Active Subscriptions
          type: HTTP_AGENT
          key: frappe.subscriptions.active
          delay: 5m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.subscriptions.active\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        - uuid: 7e065d81-691e-4fb2-a0ad-85fc7e9ad6be
          name: Subscriptions Processed Today
          type: HTTP_AGENT
          key: frappe.subscriptions.processed_today
          delay: 10m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.subscriptions.processed_today\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'

        - uuid: e148f1af-b072-426a-8161-cab4be7d3c2f
          name: Hours Since Last Subscription Run
          type: HTTP_AGENT
          key: frappe.scheduler.last_subscription_run
          delay: 5m
          history: 30d
          trends: 90d
          value_type: FLOAT
          units: 'h'
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.scheduler.last_subscription_run\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '999'
          triggers:
            - uuid: 9e8c4a09-de0e-44e1-93ed-8f208d7fd5b5
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.scheduler.last_subscription_run)>{$SUBSCRIPTION_DELAY_WARN}'
              name: 'Subscription processing delayed'
              priority: WARNING
              tags:
                - tag: scope
                  value: scheduler
            - uuid: 2854198d-bded-4bb5-bac9-345cf304db23
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.scheduler.last_subscription_run)>{$SUBSCRIPTION_DELAY_HIGH}'
              name: 'Subscription processing severely delayed'
              priority: HIGH
              tags:
                - tag: scope
                  value: scheduler

        # System Health Metrics
        - uuid: 109dbf7e-4780-40df-bdcc-5679b591275a
          name: Error Log Count
          type: HTTP_AGENT
          key: frappe.error_logs.count
          delay: 1m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.error_logs.count\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          triggers:
            - uuid: 9621cf73-77e4-4617-86b3-bc9671e941f2
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.error_logs.count)>{$ERROR_COUNT_WARN}'
              name: 'High error log count'
              priority: WARNING
              tags:
                - tag: scope
                  value: application

        - uuid: 3cc76613-8517-4af0-904f-fc7b81b59df8
          name: Queue Stuck Jobs
          type: HTTP_AGENT
          key: frappe.queue.stuck_jobs
          delay: 2m
          history: 30d
          trends: 90d
          value_type: UNSIGNED
          url: '{$FRAPPE_URL}/api/method/verenigingen.monitoring.zabbix_integration.get_metrics_for_zabbix'
          headers:
            - name: Authorization
              value: 'token {$FRAPPE_API_KEY}:{$FRAPPE_API_SECRET}'
          timeout: 10s
          follow_redirects: 'YES'
          output_format: JSON
          preprocessing:
            - type: JSONPATH
              parameters:
                - "$.message.metrics[\"frappe.queue.stuck_jobs\"]"
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          triggers:
            - uuid: 2fcd35ac-6499-4796-abaa-a0ccf6f3acf0
              expression: 'last(/Template Frappe Cloud Monitoring/frappe.queue.stuck_jobs)>0'
              name: 'Stuck background jobs detected'
              priority: WARNING
              tags:
                - tag: scope
                  value: queue

      tags:
        - tag: class
          value: application
        - tag: target
          value: frappe

      macros:
        - macro: '{$FRAPPE_URL}'
          value: 'https://your-site.frappe.cloud'
          description: 'Frappe site URL'
        - macro: '{$FRAPPE_API_KEY}'
          value: ''
          description: 'Frappe API key'
          type: SECRET_TEXT
        - macro: '{$FRAPPE_API_SECRET}'
          value: ''
          description: 'Frappe API secret'
          type: SECRET_TEXT
        - macro: '{$ERROR_RATE_WARN}'
          value: '5'
          description: 'Warning threshold for error rate (%)'
        - macro: '{$ERROR_RATE_HIGH}'
          value: '10'
          description: 'High threshold for error rate (%)'
        - macro: '{$RESPONSE_TIME_WARN}'
          value: '2000'
          description: 'Warning threshold for response time (ms)'
        - macro: '{$CHURN_RATE_WARN}'
          value: '5'
          description: 'Warning threshold for member churn rate (%)'
        - macro: '{$SUBSCRIPTION_DELAY_WARN}'
          value: '25'
          description: 'Warning threshold for subscription processing delay (hours)'
        - macro: '{$SUBSCRIPTION_DELAY_HIGH}'
          value: '48'
          description: 'High threshold for subscription processing delay (hours)'
        - macro: '{$ERROR_COUNT_WARN}'
          value: '10'
          description: 'Warning threshold for error log count per hour'

      valuemaps:
        - uuid: 0ac64bf2-a9a0-4cb6-8fc2-fb79330a05de
          name: 'Frappe Health Status'
          mappings:
            - type: EQUAL
              value: healthy
              newvalue: Healthy
            - type: EQUAL
              value: unhealthy
              newvalue: Unhealthy
            - type: DEFAULT
              newvalue: Unknown