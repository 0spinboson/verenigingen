# Security Setup for Verenigingen App

## Overview

The Verenigingen app now includes automatic security configuration during installation to ensure proper CSRF protection and other security settings are in place.

## What Gets Configured

During app installation (`bench --site sitename install-app verenigingen`), the following security configurations are automatically applied:

### 1. CSRF Protection
- **Development Mode**: CSRF protection remains disabled with a warning
- **Production Mode**: CSRF protection is automatically enabled (ignore_csrf = 0)
- A CSRF token is automatically generated by Frappe when protection is enabled

### 2. Session Security
- Generates a secure session secret key if not present
- Used for signing session cookies

### 3. Password Policy
- Sets minimum password score requirement
- Enables password policy enforcement
- Configures password expiration (90 days)

### 4. Security Headers (Recommendations)
- Provides nginx configuration recommendations for:
  - X-Frame-Options
  - X-Content-Type-Options
  - X-XSS-Protection
  - Strict-Transport-Security
  - Content-Security-Policy

## Manual Security Management

### Check Current Security Status
```bash
bench --site sitename execute "verenigingen.setup.security_setup.check_current_security_status"
```

### Enable CSRF Protection Manually
```bash
# Via bench command
bench --site sitename set-config ignore_csrf 0

# Or via API
bench --site sitename execute "verenigingen.setup.security_setup.enable_csrf_protection"
```

### Apply Production Security Settings
```bash
bench --site sitename execute "verenigingen.setup.security_setup.apply_production_security"
```

This will:
- Enable CSRF protection
- Disable developer mode
- Disable test mode
- Generate session secrets

## Security Score

The system calculates a security score based on:
- CSRF protection enabled (3 points)
- Encryption key present (2 points)
- Secret key present (2 points)
- Developer mode disabled (2 points)
- Test mode disabled (1 point)

Total possible score: 10 points

## Development vs Production

### Development Environment
- CSRF may remain disabled for easier testing
- Developer mode enabled for debugging
- Test mode enabled for running tests
- **Security Score**: Typically 2-4/10

### Production Environment
- CSRF protection must be enabled
- Developer mode must be disabled
- Test mode must be disabled
- **Target Security Score**: 8-10/10

## CSRF Token Behavior

When CSRF protection is enabled:
1. Frappe automatically generates a CSRF token for each session
2. The token is included in all forms and AJAX requests
3. Token validation happens automatically on the server
4. No additional configuration needed in the app code

## Troubleshooting

### "CSRF token missing" errors
1. Ensure CSRF protection is properly enabled
2. Clear browser cache and cookies
3. Restart the bench: `bench restart`

### Security score is low
Run the production security setup:
```bash
bench --site sitename execute "verenigingen.setup.security_setup.apply_production_security"
bench restart
```

### Check what's missing
```bash
bench --site sitename execute "verenigingen.setup.security_setup.check_current_security_status"
```

## Best Practices

1. **Always enable CSRF protection in production**
   ```bash
   bench --site production-site set-config ignore_csrf 0
   ```

2. **Generate strong secrets**
   - Encryption key and secret key are automatically generated
   - Never share or commit these keys

3. **Configure nginx security headers**
   - Add the recommended headers to your nginx configuration
   - See output from security setup for specific headers

4. **Regular security audits**
   - Run security status check monthly
   - Update password policies as needed
   - Review user permissions regularly

## Files Modified During Installation

- `sites/{sitename}/site_config.json` - Security settings stored here
- No CSRF token files are created (handled in database/session)

## Re-running Security Setup

If you need to re-run the security setup after installation:

```python
bench --site sitename console

from verenigingen.setup.security_setup import setup_all_security
result = setup_all_security()
print(result)
```

## Security Configuration API

The module provides several whitelisted functions for security management:

- `check_current_security_status()` - Get current security configuration
- `enable_csrf_protection()` - Enable CSRF protection
- `apply_production_security()` - Apply all production security settings

These can be called via the Frappe API or bench execute commands.
