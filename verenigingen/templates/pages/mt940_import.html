{% extends "templates/web.html" %}

{% block title %}{{ _("Import MT940 Bank Statement") }}{% endblock %}

{% block page_content %}
<div class="container mt940-import-page">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
            <div class="page-header">
                <h1>{{ _("Import Bank Transactions") }}</h1>
                <p class="text-muted">{{ _("Import transactions from MT940 files or Mollie backend") }}</p>
            </div>

            <!-- Import Type Selection -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4>{{ _("Import Type") }}</h4>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="import-type-option" id="mt940-option">
                                <div class="card" style="cursor: pointer; border: 2px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <div class="text-center">
                                        <i class="fa fa-file-text-o fa-3x text-primary"></i>
                                        <h4>MT940 File Import</h4>
                                        <p class="text-muted">Upload MT940 bank statement files</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="import-type-option" id="mollie-option">
                                <div class="card" style="cursor: pointer; border: 2px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <div class="text-center">
                                        <i class="fa fa-cloud fa-3x text-success"></i>
                                        <h4>Mollie Bulk Import</h4>
                                        <p class="text-muted">Import transactions from Mollie backend API</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MT940 Import Panel -->
            <div class="panel panel-default" id="mt940-panel">
                <div class="panel-heading">
                    <h4>{{ _("MT940 File Import") }}</h4>
                </div>
                <div class="panel-body">
                    <form id="mt940-import-form" enctype="multipart/form-data">

                        <!-- Bank Account Selection -->
                        <div class="form-group" id="bank-account-group">
                            <label for="bank_account">{{ _("Bank Account") }}</label>
                            <select class="form-control" id="bank_account" name="bank_account" required>
                                <option value="">{{ _("Select Bank Account") }}</option>
                                {% for account in bank_accounts %}
                                <option value="{{ account.name }}"
                                        data-bank="{{ account.bank }}"
                                        data-iban="{{ account.iban or '' }}"
                                        data-account-no="{{ account.bank_account_no or '' }}">
                                    {{ account.account_name }}
                                    {% if account.bank %}({{ account.bank }}){% endif %}
                                    {% if account.iban %}- {{ account.iban }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- File Upload -->
                        <div class="form-group">
                            <label for="mt940_file">{{ _("MT940 File") }}</label>
                            <input type="file" class="form-control" id="mt940_file" name="mt940_file"
                                   accept=".mt940,.txt,.sta,.940" required>
                            <small class="help-text text-muted">
                                {{ _("Select your MT940 bank statement file (.mt940, .txt, .sta, or .940 format)") }}
                            </small>
                        </div>

                        <!-- Submit Button -->
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="import-btn">
                                <i class="fa fa-upload"></i> {{ _("Import Transactions") }}
                            </button>
                            <button type="button" class="btn btn-info" id="debug-btn">
                                <i class="fa fa-bug"></i> {{ _("Debug File") }}
                            </button>
                            <button type="button" class="btn btn-warning" id="debug-improved-btn">
                                <i class="fa fa-cogs"></i> {{ _("Debug Improved") }}
                            </button>
                            <button type="button" class="btn btn-success" id="test-extraction-btn">
                                <i class="fa fa-check"></i> {{ _("Test Extraction") }}
                            </button>
                            <button type="button" class="btn btn-danger" id="debug-detailed-btn">
                                <i class="fa fa-wrench"></i> {{ _("Debug Import") }}
                            </button>
                            <button type="button" class="btn btn-default" onclick="window.history.back()">
                                {{ _("Cancel") }}
                            </button>
                        </div>

                    </form>

                    <!-- Progress Indicator -->
                    <div id="progress-section" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 100%">
                                {{ _("Processing MT940 file...") }}
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="results-section" style="display: none;">
                        <div class="alert" id="results-alert">
                            <div id="results-content"></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Mollie Bulk Import Panel -->
            <div class="panel panel-default" id="mollie-panel" style="display: none;">
                <div class="panel-heading">
                    <h4>{{ _("Mollie Bulk Import") }}</h4>
                </div>
                <div class="panel-body">
                    <form id="mollie-import-form">

                        <!-- Bank Account Selection (shared) -->
                        <div class="form-group">
                            <label for="mollie_bank_account">{{ _("Bank Account") }}</label>
                            <select class="form-control" id="mollie_bank_account" name="mollie_bank_account" required>
                                <option value="">{{ _("Select Bank Account") }}</option>
                                {% for account in bank_accounts %}
                                <option value="{{ account.name }}">
                                    {{ account.account_name }}
                                    {% if account.bank %}({{ account.bank }}){% endif %}
                                    {% if account.iban %}- {{ account.iban }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Date Range -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="mollie_from_date">{{ _("From Date") }}</label>
                                    <input type="date" class="form-control" id="mollie_from_date" name="mollie_from_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="mollie_to_date">{{ _("To Date") }}</label>
                                    <input type="date" class="form-control" id="mollie_to_date" name="mollie_to_date" required>
                                </div>
                            </div>
                        </div>

                        <!-- Import Strategy -->
                        <div class="form-group">
                            <label for="mollie_strategy">{{ _("Import Strategy") }}</label>
                            <select class="form-control" id="mollie_strategy" name="mollie_strategy">
                                <option value="hybrid">{{ _("Hybrid (Settlements + Payments) - Recommended") }}</option>
                                <option value="settlements">{{ _("Settlements Only - Faster, Less Detail") }}</option>
                                <option value="payments">{{ _("Individual Payments - Detailed, Slower") }}</option>
                            </select>
                            <small class="help-text text-muted">
                                {{ _("Hybrid combines settlement data for bulk periods with individual payments for recent transactions") }}
                            </small>
                        </div>

                        <!-- Import Size Estimate -->
                        <div id="mollie-estimate-section" style="display: none;">
                            <div class="alert alert-info" id="mollie-estimate-result">
                                <h5><i class="fa fa-info-circle"></i> {{ _("Import Estimate") }}</h5>
                                <div id="mollie-estimate-content"></div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="form-group">
                            <button type="button" class="btn btn-info" id="mollie-estimate-btn">
                                <i class="fa fa-calculator"></i> {{ _("Estimate Import Size") }}
                            </button>
                            <button type="submit" class="btn btn-success" id="mollie-import-btn" disabled>
                                <i class="fa fa-cloud-download"></i> {{ _("Start Bulk Import") }}
                            </button>
                            <button type="button" class="btn btn-default" id="mollie-back-btn">
                                {{ _("Back to Import Type") }}
                            </button>
                        </div>

                    </form>

                    <!-- Mollie Progress Indicator -->
                    <div id="mollie-progress-section" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 100%">
                                {{ _("Processing Mollie bulk import...") }}
                            </div>
                        </div>
                        <p class="text-muted text-center">{{ _("This may take a few minutes for large date ranges") }}</p>
                    </div>

                    <!-- Mollie Results Section -->
                    <div id="mollie-results-section" style="display: none;">
                        <div class="alert" id="mollie-results-alert">
                            <div id="mollie-results-content"></div>
                        </div>
                    </div>

                    <!-- Mollie Import History -->
                    <div id="mollie-history-section" style="display: none;">
                        <h4>{{ _("Recent Bulk Imports") }}</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="mollie-history-table">
                                <thead>
                                    <tr>
                                        <th>{{ _("Import Name") }}</th>
                                        <th>{{ _("Date Range") }}</th>
                                        <th>{{ _("Status") }}</th>
                                        <th>{{ _("Transactions") }}</th>
                                        <th>{{ _("Actions") }}</th>
                                    </tr>
                                </thead>
                                <tbody id="mollie-history-body">
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Help Section -->
            <div class="panel panel-info" id="help-section">
                <div class="panel-heading">
                    <h4>{{ _("Import Methods") }}</h4>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>{{ _("MT940 File Import") }}</h5>
                            <p>{{ _("MT940 is a standard format for electronic bank statements used by banks worldwide. It contains:") }}</p>
                            <ul>
                                <li>{{ _("Transaction details (date, amount, description)") }}</li>
                                <li>{{ _("Account information (IBAN, account number)") }}</li>
                                <li>{{ _("Balance information (opening and closing balances)") }}</li>
                                <li>{{ _("Reference numbers and additional transaction data") }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>{{ _("Mollie Bulk Import") }}</h5>
                            <p>{{ _("Import transaction data directly from Mollie's backend API:") }}</p>
                            <ul>
                                <li>{{ _("Historical data backfill for any date range") }}</li>
                                <li>{{ _("Settlement data for bulk financial periods") }}</li>
                                <li>{{ _("Individual payment details with full metadata") }}</li>
                                <li>{{ _("Hybrid strategy for optimal performance") }}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-info" style="margin-top: 15px;">
                        <strong>{{ _("Note:") }}</strong> {{ _("Both import methods create Bank Transaction records. You'll need to reconcile them with your accounting entries separately.") }}
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
.mt940-import-page {
    margin-top: 30px;
    margin-bottom: 50px;
}

.page-header {
    border-bottom: 1px solid #eee;
    padding-bottom: 20px;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.help-text {
    margin-top: 5px;
    display: block;
}

#results-section .alert {
    margin-top: 20px;
}

.transaction-summary {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.transaction-summary h5 {
    margin-top: 0;
    color: #495057;
}

/* Import type selection */
.import-type-option .card {
    transition: all 0.3s ease;
}

.import-type-option .card:hover {
    border-color: #007bff !important;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
}

.import-type-option.selected .card {
    border-color: #28a745 !important;
    background-color: #f8fff9;
}

/* Initially hide both import panels */
#mt940-panel, #mollie-panel {
    display: none;
}

/* Mollie specific styles */
.mollie-estimate-item {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.mollie-estimate-item:last-child {
    border-bottom: none;
}

.mollie-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Import type selection elements
    const mt940Option = document.getElementById('mt940-option');
    const mollieOption = document.getElementById('mollie-option');
    const mt940Panel = document.getElementById('mt940-panel');
    const molliePanel = document.getElementById('mollie-panel');

    // MT940 form elements
    const bankAccountSelect = document.getElementById('bank_account');
    const form = document.getElementById('mt940-import-form');
    const importBtn = document.getElementById('import-btn');
    const debugBtn = document.getElementById('debug-btn');
    const debugImprovedBtn = document.getElementById('debug-improved-btn');
    const testExtractionBtn = document.getElementById('test-extraction-btn');
    const debugDetailedBtn = document.getElementById('debug-detailed-btn');
    const progressSection = document.getElementById('progress-section');
    const resultsSection = document.getElementById('results-section');
    const resultsAlert = document.getElementById('results-alert');
    const resultsContent = document.getElementById('results-content');

    // Mollie form elements
    const mollieForm = document.getElementById('mollie-import-form');
    const mollieBankAccountSelect = document.getElementById('mollie_bank_account');
    const mollieFromDate = document.getElementById('mollie_from_date');
    const mollieToDate = document.getElementById('mollie_to_date');
    const mollieStrategy = document.getElementById('mollie_strategy');
    const mollieEstimateBtn = document.getElementById('mollie-estimate-btn');
    const mollieImportBtn = document.getElementById('mollie-import-btn');
    const mollieBackBtn = document.getElementById('mollie-back-btn');
    const mollieEstimateSection = document.getElementById('mollie-estimate-section');
    const mollieEstimateContent = document.getElementById('mollie-estimate-content');
    const mollieProgressSection = document.getElementById('mollie-progress-section');
    const mollieResultsSection = document.getElementById('mollie-results-section');
    const mollieResultsAlert = document.getElementById('mollie-results-alert');
    const mollieResultsContent = document.getElementById('mollie-results-content');

    // Import type selection handlers
    mt940Option.addEventListener('click', function() {
        selectImportType('mt940');
    });

    mollieOption.addEventListener('click', function() {
        selectImportType('mollie');
    });

    function selectImportType(type) {
        // Reset selections
        mt940Option.classList.remove('selected');
        mollieOption.classList.remove('selected');
        mt940Panel.style.display = 'none';
        molliePanel.style.display = 'none';

        if (type === 'mt940') {
            mt940Option.classList.add('selected');
            mt940Panel.style.display = 'block';
        } else if (type === 'mollie') {
            mollieOption.classList.add('selected');
            molliePanel.style.display = 'block';
            // Load Mollie import history when panel is shown
            loadMollieImportHistory();
        }
    }

    // Mollie back button
    mollieBackBtn.addEventListener('click', function() {
        mollieOption.classList.remove('selected');
        molliePanel.style.display = 'none';
        // Reset Mollie form
        mollieForm.reset();
        mollieImportBtn.disabled = true;
        mollieEstimateSection.style.display = 'none';
        mollieProgressSection.style.display = 'none';
        mollieResultsSection.style.display = 'none';
    });

    // Bank account is always required now

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const fileInput = document.getElementById('mt940_file');
        const file = fileInput.files[0];

        if (!file) {
            frappe.msgprint('Please select an MT940 file');
            return;
        }

        // Show progress
        importBtn.disabled = true;
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';

        // Read file as base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileContent = btoa(e.target.result);

            // Prepare API call - always use manual mode
            const apiMethod = 'verenigingen.api.member_management.import_mt940_improved';
            const apiArgs = {
                bank_account: bankAccountSelect.value,
                file_content: fileContent,
                company: '{{ company }}'
            };

            // Call import API
            frappe.call({
                method: apiMethod,
                args: apiArgs,
                callback: function(r) {
                    importBtn.disabled = false;
                    progressSection.style.display = 'none';

                    if (r.message) {
                        showResults(r.message);
                    } else {
                        showError('No response from server');
                    }
                },
                error: function(err) {
                    importBtn.disabled = false;
                    progressSection.style.display = 'none';
                    showError('Import failed: ' + (err.message || 'Unknown error'));
                }
            });
        };

        reader.readAsBinaryString(file);
    });

    // Mollie estimate button
    mollieEstimateBtn.addEventListener('click', function() {
        const fromDate = mollieFromDate.value;
        const toDate = mollieToDate.value;
        const strategy = mollieStrategy.value;

        if (!fromDate || !toDate) {
            frappe.msgprint('Please select from and to dates');
            return;
        }

        if (new Date(fromDate) >= new Date(toDate)) {
            frappe.msgprint('From date must be before to date');
            return;
        }

        mollieEstimateBtn.disabled = true;

        frappe.call({
            method: 'verenigingen.verenigingen.doctype.mt940_import.mt940_import.estimate_mollie_bulk_import',
            args: {
                from_date: fromDate,
                to_date: toDate,
                strategy: strategy
            },
            callback: function(r) {
                mollieEstimateBtn.disabled = false;

                if (r.message && !r.message.error) {
                    showMollieEstimate(r.message);
                    mollieImportBtn.disabled = false; // Enable import after successful estimate
                } else {
                    frappe.msgprint('Estimate failed: ' + (r.message?.error || 'Unknown error'));
                }
            },
            error: function(err) {
                mollieEstimateBtn.disabled = false;
                frappe.msgprint('Estimate failed: ' + (err.message || 'Unknown error'));
            }
        });
    });

    // Mollie form submission
    mollieForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const fromDate = mollieFromDate.value;
        const toDate = mollieToDate.value;
        const strategy = mollieStrategy.value;
        const bankAccount = mollieBankAccountSelect.value;

        if (!bankAccount) {
            frappe.msgprint('Please select a bank account');
            return;
        }

        // Show progress
        mollieImportBtn.disabled = true;
        mollieProgressSection.style.display = 'block';
        mollieResultsSection.style.display = 'none';

        // Create and submit the import
        frappe.call({
            method: 'verenigingen.verenigingen.doctype.mt940_import.mt940_import.create_mollie_bulk_import',
            args: {
                from_date: fromDate,
                to_date: toDate,
                strategy: strategy,
                company: '{{ company }}',
                bank_account: bankAccount
            },
            callback: function(r) {
                if (r.message && r.message.success) {
                    // Import document created, now submit it to start processing
                    submitMollieImport(r.message.import_doc_name);
                } else {
                    mollieImportBtn.disabled = false;
                    mollieProgressSection.style.display = 'none';
                    frappe.msgprint('Failed to create import: ' + (r.message?.error || 'Unknown error'));
                }
            },
            error: function(err) {
                mollieImportBtn.disabled = false;
                mollieProgressSection.style.display = 'none';
                frappe.msgprint('Import creation failed: ' + (err.message || 'Unknown error'));
            }
        });
    });

    // Debug button functionality
    debugBtn.addEventListener('click', function() {
        const fileInput = document.getElementById('mt940_file');
        const file = fileInput.files[0];

        if (!file) {
            frappe.msgprint('Please select an MT940 file');
            return;
        }

        // Show progress
        debugBtn.disabled = true;
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';

        // Read file as base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileContent = btoa(e.target.result);

            // Call debug API
            frappe.call({
                method: 'verenigingen.api.member_management.debug_mt940_import',
                args: {
                    file_content: fileContent,
                    bank_account: bankAccountSelect.value || null
                },
                callback: function(r) {
                    debugBtn.disabled = false;
                    progressSection.style.display = 'none';

                    if (r.message) {
                        showDebugResults(r.message);
                    } else {
                        showError('No debug response from server');
                    }
                },
                error: function(err) {
                    debugBtn.disabled = false;
                    progressSection.style.display = 'none';
                    showError('Debug failed: ' + (err.message || 'Unknown error'));
                }
            });
        };

        reader.readAsBinaryString(file);
    });

    // Debug Improved button functionality
    debugImprovedBtn.addEventListener('click', function() {
        const fileInput = document.getElementById('mt940_file');
        const file = fileInput.files[0];

        if (!file) {
            frappe.msgprint('Please select an MT940 file');
            return;
        }

        // Show progress
        debugImprovedBtn.disabled = true;
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';

        // Read file as base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileContent = btoa(e.target.result);

            // Call improved debug API
            frappe.call({
                method: 'verenigingen.api.member_management.debug_mt940_import_improved',
                args: {
                    file_content: fileContent,
                    bank_account: bankAccountSelect.value || null
                },
                callback: function(r) {
                    debugImprovedBtn.disabled = false;
                    progressSection.style.display = 'none';

                    if (r.message) {
                        showDebugResults(r.message);
                    } else {
                        showError('No debug response from server');
                    }
                },
                error: function(err) {
                    debugImprovedBtn.disabled = false;
                    progressSection.style.display = 'none';
                    showError('Debug failed: ' + (err.message || 'Unknown error'));
                }
            });
        };

        reader.readAsBinaryString(file);
    });

    // Test Extraction button functionality
    testExtractionBtn.addEventListener('click', function() {
        const fileInput = document.getElementById('mt940_file');
        const file = fileInput.files[0];

        if (!file) {
            frappe.msgprint('Please select an MT940 file');
            return;
        }

        // Show progress
        testExtractionBtn.disabled = true;
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';

        // Read file as base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileContent = btoa(e.target.result);

            // Call test extraction API
            frappe.call({
                method: 'verenigingen.api.member_management.test_mt940_extraction',
                args: {
                    file_content: fileContent,
                    bank_account: bankAccountSelect.value || null
                },
                callback: function(r) {
                    testExtractionBtn.disabled = false;
                    progressSection.style.display = 'none';

                    if (r.message) {
                        showExtractionTestResults(r.message);
                    } else {
                        showError('No response from server');
                    }
                },
                error: function(err) {
                    testExtractionBtn.disabled = false;
                    progressSection.style.display = 'none';
                    showError('Test failed: ' + (err.message || 'Unknown error'));
                }
            });
        };

        reader.readAsBinaryString(file);
    });

    // Debug Detailed button functionality
    debugDetailedBtn.addEventListener('click', function() {
        const fileInput = document.getElementById('mt940_file');
        const file = fileInput.files[0];

        if (!file) {
            frappe.msgprint('Please select an MT940 file');
            return;
        }

        // Show progress
        debugDetailedBtn.disabled = true;
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';

        // Read file as base64
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileContent = btoa(e.target.result);

            // Call detailed debug API
            frappe.call({
                method: 'verenigingen.api.member_management.debug_mt940_import_detailed',
                args: {
                    file_content: fileContent,
                    bank_account: bankAccountSelect.value || null
                },
                callback: function(r) {
                    debugDetailedBtn.disabled = false;
                    progressSection.style.display = 'none';

                    if (r.message) {
                        showDetailedDebugResults(r.message);
                    } else {
                        showError('No response from server');
                    }
                },
                error: function(err) {
                    debugDetailedBtn.disabled = false;
                    progressSection.style.display = 'none';
                    showError('Debug failed: ' + (err.message || 'Unknown error'));
                }
            });
        };

        reader.readAsBinaryString(file);
    });

    function showResults(result) {
        resultsSection.style.display = 'block';

        if (result.success) {
            resultsAlert.className = 'alert alert-success';
            resultsContent.innerHTML = formatSuccessResults(result);
        } else {
            resultsAlert.className = 'alert alert-danger';
            resultsContent.innerHTML = formatErrorResults(result);
        }
    }

    function showError(message) {
        resultsSection.style.display = 'block';
        resultsAlert.className = 'alert alert-danger';
        resultsContent.innerHTML = '<strong>Error:</strong> ' + message;
    }

    function formatSuccessResults(result) {
        let html = '<h4><i class="fa fa-check-circle"></i> Import Successful!</h4>';

        if (result.bank_account) {
            html += '<p><strong>Bank Account:</strong> ' + result.bank_account + '</p>';
        }

        if (result.transactions_created) {
            html += '<p><strong>Transactions Created:</strong> ' + result.transactions_created + '</p>';
        }

        if (result.transactions_updated) {
            html += '<p><strong>Transactions Updated:</strong> ' + result.transactions_updated + '</p>';
        }

        if (result.transactions_skipped) {
            html += '<p><strong>Transactions Skipped:</strong> ' + result.transactions_skipped + '</p>';
        }

        if (result.statement_info) {
            html += '<div class="transaction-summary">';
            html += '<h5>Statement Information</h5>';
            if (result.statement_info.account_iban) {
                html += '<p><strong>Account IBAN:</strong> ' + result.statement_info.account_iban + '</p>';
            }
            if (result.statement_info.opening_balance) {
                html += '<p><strong>Opening Balance:</strong> ' + result.statement_info.opening_balance + '</p>';
            }
            if (result.statement_info.closing_balance) {
                html += '<p><strong>Closing Balance:</strong> ' + result.statement_info.closing_balance + '</p>';
            }
            if (result.statement_info.statement_date) {
                html += '<p><strong>Statement Date:</strong> ' + result.statement_info.statement_date + '</p>';
            }
            html += '</div>';
        }

        html += '<p class="text-muted"><strong>Next Step:</strong> Review and reconcile the imported transactions in the Bank Transaction list.</p>';
        html += '<a href="/app/bank-transaction" class="btn btn-default">View Bank Transactions</a>';

        return html;
    }

    function formatErrorResults(result) {
        let html = '<h4><i class="fa fa-exclamation-circle"></i> Import Failed</h4>';
        html += '<p><strong>Error:</strong> ' + (result.message || 'Unknown error occurred') + '</p>';

        if (result.extracted_iban) {
            html += '<p><strong>Extracted IBAN:</strong> ' + result.extracted_iban + '</p>';
            html += '<p class="text-info">You may need to create a Bank Account record with this IBAN, or use manual mode to select an existing account.</p>';
        }

        return html;
    }

    function showDebugResults(debug) {
        resultsSection.style.display = 'block';
        resultsAlert.className = 'alert alert-info';

        let html = '<h4><i class="fa fa-bug"></i> Debug Information</h4>';

        if (debug.error) {
            html += '<div class="alert alert-danger"><strong>Error:</strong> ' + debug.error + '</div>';
            if (debug.traceback) {
                html += '<pre style="font-size: 11px; max-height: 200px; overflow-y: auto;">' + debug.traceback + '</pre>';
            }
        } else {
            html += '<div class="row">';
            html += '<div class="col-md-6">';
            html += '<h5>File Processing</h5>';
            html += '<p><strong>Step:</strong> ' + debug.step + '</p>';
            html += '<p><strong>Content Length:</strong> ' + debug.content_length + ' characters</p>';

            if (debug.statements_found !== undefined) {
                html += '<p><strong>Statements Found:</strong> ' + debug.statements_found + '</p>';
            }

            if (debug.parse_error) {
                html += '<div class="alert alert-warning"><strong>Parse Error:</strong> ' + debug.parse_error + '</div>';
            }

            html += '</div>';
            html += '<div class="col-md-6">';

            if (debug.first_statement) {
                html += '<h5>First Statement</h5>';
                html += '<p><strong>Has Data:</strong> ' + debug.first_statement.has_data + '</p>';
                html += '<p><strong>Has Transactions:</strong> ' + debug.first_statement.has_transactions + '</p>';
                html += '<p><strong>Transaction Count:</strong> ' + debug.first_statement.transaction_count + '</p>';
                if (debug.first_statement.data_keys && debug.first_statement.data_keys.length > 0) {
                    html += '<p><strong>Data Keys:</strong> ' + debug.first_statement.data_keys.join(', ') + '</p>';
                }
            }

            if (debug.first_transaction) {
                html += '<h5>First Transaction</h5>';

                // Show detailed inspection data (from improved debug)
                html += '<h6>Object Inspection:</h6>';
                html += '<ul>';
                html += '<li><strong>Has Date Attribute:</strong> ' + (debug.first_transaction.has_date_attr || 'Unknown') + '</li>';
                html += '<li><strong>Date Attribute Value:</strong> ' + (debug.first_transaction.date_value || debug.first_transaction.raw_date || 'None') + '</li>';
                html += '<li><strong>Data Date Value:</strong> ' + (debug.first_transaction.data_date || 'None') + '</li>';
                html += '<li><strong>Has Amount Attribute:</strong> ' + (debug.first_transaction.has_amount_attr || 'Unknown') + '</li>';
                html += '<li><strong>Amount Attribute Value:</strong> ' + (debug.first_transaction.amount_value || debug.first_transaction.raw_amount || 'None') + '</li>';
                html += '<li><strong>Amount Type:</strong> ' + (debug.first_transaction.amount_type || 'Unknown') + '</li>';
                html += '<li><strong>Data Amount Value:</strong> ' + (debug.first_transaction.data_amount || 'None') + '</li>';
                html += '</ul>';

                html += '<p><strong>Has Data:</strong> ' + debug.first_transaction.has_data + '</p>';
                if (debug.first_transaction.data_keys && debug.first_transaction.data_keys.length > 0) {
                    html += '<p><strong>Data Keys:</strong> ' + debug.first_transaction.data_keys.join(', ') + '</p>';
                }

                // Show extracted data if available (from improved debug)
                if (debug.first_transaction.extracted_data) {
                    html += '<h6>Extracted Data:</h6>';
                    const extracted = debug.first_transaction.extracted_data;
                    if (extracted) {
                        html += '<ul>';
                        html += '<li><strong>Date:</strong> ' + (extracted.date || 'Not extracted') + '</li>';
                        html += '<li><strong>Amount:</strong> ' + (extracted.amount !== null ? extracted.amount : 'Not extracted') + '</li>';
                        html += '<li><strong>Currency:</strong> ' + (extracted.currency || 'Not extracted') + '</li>';
                        html += '<li><strong>Description:</strong> ' + (extracted.description || 'Not extracted') + '</li>';
                        html += '<li><strong>Reference:</strong> ' + (extracted.reference || 'Not extracted') + '</li>';
                        html += '</ul>';
                    } else {
                        html += '<p class="text-danger">Failed to extract transaction data</p>';
                    }
                }
            }

            html += '</div>';
            html += '</div>';

            if (debug.content_preview) {
                html += '<h5>File Content Preview</h5>';
                html += '<pre style="font-size: 11px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">' + debug.content_preview + '</pre>';
            }
        }

        resultsContent.innerHTML = html;
    }

    function showExtractionTestResults(result) {
        resultsSection.style.display = 'block';

        if (result.success) {
            resultsAlert.className = 'alert alert-success';
            let html = '<h4><i class="fa fa-check-circle"></i> Extraction Test Results</h4>';

            html += '<div class="row">';
            html += '<div class="col-md-6">';
            html += '<h5>Raw Data</h5>';
            html += '<ul>';
            html += '<li><strong>Date:</strong> ' + (result.raw_data.date || 'None') + '</li>';
            html += '<li><strong>Amount:</strong> ' + (result.raw_data.amount || 'None') + '</li>';
            html += '<li><strong>Currency:</strong> ' + (result.raw_data.currency || 'None') + '</li>';
            html += '</ul>';
            html += '</div>';

            html += '<div class="col-md-6">';
            html += '<h5>Extracted Data</h5>';
            if (result.extracted) {
                html += '<ul>';
                html += '<li><strong>Date:</strong> ' + (result.extracted.date || 'Failed to extract') + '</li>';
                html += '<li><strong>Amount:</strong> ' + (result.extracted.amount !== null ? result.extracted.amount : 'Failed to extract') + '</li>';
                html += '<li><strong>Currency:</strong> ' + (result.extracted.currency || 'Failed to extract') + '</li>';
                html += '<li><strong>Description:</strong> ' + (result.extracted.description || 'None') + '</li>';
                html += '</ul>';

                if (result.extracted.date && result.extracted.amount !== null) {
                    html += '<div class="alert alert-success"><strong>✓ Extraction Successful!</strong> Ready for import.</div>';
                } else {
                    html += '<div class="alert alert-warning"><strong>⚠ Extraction Issues</strong> Some data could not be extracted.</div>';
                }
            } else {
                if (result.extraction_error) {
                    html += '<div class="alert alert-danger"><strong>✗ Extraction Failed</strong><br>' + result.extraction_error + '</div>';
                } else {
                    html += '<div class="alert alert-danger"><strong>✗ Extraction Failed</strong> Could not extract transaction data.</div>';
                }
            }
            html += '</div>';
            html += '</div>';

            resultsContent.innerHTML = html;
        } else {
            resultsAlert.className = 'alert alert-danger';
            resultsContent.innerHTML = '<h4><i class="fa fa-exclamation-circle"></i> Test Failed</h4><p>' + (result.error || 'Unknown error') + '</p>';
        }
    }

    function showDetailedDebugResults(result) {
        resultsSection.style.display = 'block';
        resultsAlert.className = 'alert alert-info';

        let html = '<h4><i class="fa fa-wrench"></i> Detailed Import Debug</h4>';

        if (result.error) {
            html += '<div class="alert alert-danger"><strong>Error:</strong> ' + result.error + '</div>';
        } else {
            html += '<ul>';
            html += '<li><strong>Step:</strong> ' + result.step + '</li>';
            html += '<li><strong>Content Length:</strong> ' + result.content_length + ' characters</li>';

            if (result.extracted_iban) {
                html += '<li><strong>Extracted IBAN:</strong> ' + result.extracted_iban + '</li>';
            }

            if (result.found_bank_account) {
                html += '<li><strong>Found Bank Account:</strong> ' + result.found_bank_account + '</li>';
            }

            html += '<li><strong>Final Bank Account:</strong> ' + (result.final_bank_account || 'None') + '</li>';
            html += '<li><strong>Final Company:</strong> ' + (result.final_company || 'None') + '</li>';

            if (result.statements_found) {
                html += '<li><strong>Statements Found:</strong> ' + result.statements_found + '</li>';
            }

            if (result.extraction_result) {
                html += '<li><strong>Extraction Result:</strong> ✓ Success</li>';
                html += '<li><strong>Extracted Date:</strong> ' + (result.extraction_result.date || 'None') + '</li>';
                html += '<li><strong>Extracted Amount:</strong> ' + (result.extraction_result.amount || 'None') + '</li>';
            } else {
                html += '<li><strong>Extraction Result:</strong> ✗ Failed</li>';
            }

            if (result.creation_result) {
                html += '<li><strong>Transaction Creation:</strong> ' + result.creation_result + '</li>';

                if (result.creation_result === 'created') {
                    html += '<div class="alert alert-success"><strong>✓ Success!</strong> Transaction was created successfully.</div>';
                } else if (result.creation_result === 'exists') {
                    html += '<div class="alert alert-warning"><strong>Already Exists</strong> Transaction already in database.</div>';
                } else {
                    html += '<div class="alert alert-danger"><strong>Creation Failed:</strong> ' + result.creation_result + '</div>';
                }
            }

            html += '</ul>';
        }

        resultsContent.innerHTML = html;
    }

    // Mollie-specific functions
    function submitMollieImport(importDocName) {
        frappe.call({
            method: 'verenigingen.verenigingen.doctype.mt940_import.mt940_import.submit_import',
            args: {
                import_name: importDocName
            },
            callback: function(r) {
                mollieImportBtn.disabled = false;
                mollieProgressSection.style.display = 'none';

                if (r.message) {
                    showMollieResults(r.message);
                    loadMollieImportHistory(); // Refresh history
                } else {
                    mollieResultsSection.style.display = 'block';
                    mollieResultsAlert.className = 'alert alert-warning';
                    mollieResultsContent.innerHTML = '<h4>Import Started</h4><p>Import document created: ' + importDocName + '</p><p>Check the document status for progress updates.</p>';
                }
            },
            error: function(err) {
                mollieImportBtn.disabled = false;
                mollieProgressSection.style.display = 'none';
                mollieResultsSection.style.display = 'block';
                mollieResultsAlert.className = 'alert alert-danger';
                mollieResultsContent.innerHTML = '<h4>Submit Failed</h4><p>' + (err.message || 'Unknown error') + '</p>';
            }
        });
    }

    function showMollieEstimate(estimate) {
        let html = '';

        if (estimate.error) {
            html = '<div class="alert alert-danger">' + estimate.error + '</div>';
        } else {
            html += '<div class="mollie-estimate-item"><strong>Date Range:</strong> ' + estimate.date_range.days + ' days (' + estimate.date_range.from.split('T')[0] + ' to ' + estimate.date_range.to.split('T')[0] + ')</div>';
            html += '<div class="mollie-estimate-item"><strong>Strategy:</strong> ' + estimate.strategy.charAt(0).toUpperCase() + estimate.strategy.slice(1) + '</div>';
            html += '<div class="mollie-estimate-item"><strong>Estimated Transactions:</strong> ~' + estimate.estimated_transactions + '</div>';

            if (estimate.settlements_count !== undefined) {
                html += '<div class="mollie-estimate-item"><strong>Settlements Found:</strong> ' + estimate.settlements_count + '</div>';
            }

            if (estimate.estimated_payments !== undefined) {
                html += '<div class="mollie-estimate-item"><strong>Estimated Payments:</strong> ~' + estimate.estimated_payments + '</div>';
            }

            if (estimate.warnings && estimate.warnings.length > 0) {
                html += '<div class="alert alert-warning mollie-warning" style="margin-top: 15px;"><strong>Warnings:</strong><ul>';
                for (let warning of estimate.warnings) {
                    html += '<li>' + warning + '</li>';
                }
                html += '</ul></div>';
            }
        }

        mollieEstimateContent.innerHTML = html;
        mollieEstimateSection.style.display = 'block';
    }

    function showMollieResults(result) {
        mollieResultsSection.style.display = 'block';

        let html = '<h4><i class="fa fa-check-circle"></i> Mollie Bulk Import Results</h4>';

        if (result.import_status === 'Completed') {
            mollieResultsAlert.className = 'alert alert-success';
            html += '<p><strong>Status:</strong> ' + result.import_status + '</p>';
            html += '<p><strong>Import Summary:</strong> ' + (result.import_summary || 'Import completed successfully') + '</p>';

            if (result.transactions_created) {
                html += '<p><strong>Transactions Created:</strong> ' + result.transactions_created + '</p>';
            }

            if (result.transactions_skipped) {
                html += '<p><strong>Transactions Skipped:</strong> ' + result.transactions_skipped + '</p>';
            }

            html += '<p class="text-muted"><strong>Next Step:</strong> Review and reconcile the imported transactions.</p>';
            html += '<a href="/app/bank-transaction" class="btn btn-default">View Bank Transactions</a>';
            html += ' <a href="/app/mt940-import/' + result.name + '" class="btn btn-info">View Import Details</a>';

        } else {
            mollieResultsAlert.className = 'alert alert-danger';
            html += '<p><strong>Status:</strong> ' + result.import_status + '</p>';
            html += '<p><strong>Error:</strong> ' + (result.import_summary || 'Import failed') + '</p>';
        }

        mollieResultsContent.innerHTML = html;
    }

    function loadMollieImportHistory() {
        frappe.call({
            method: 'verenigingen.verenigingen.doctype.mt940_import.mt940_import.get_mollie_bulk_import_history',
            args: { days: 30 },
            callback: function(r) {
                if (r.message && r.message.length > 0) {
                    displayMollieHistory(r.message);
                } else {
                    document.getElementById('mollie-history-section').style.display = 'none';
                }
            },
            error: function(err) {
                console.log('Failed to load Mollie import history:', err);
            }
        });
    }

    function displayMollieHistory(imports) {
        const historySection = document.getElementById('mollie-history-section');
        const historyBody = document.getElementById('mollie-history-body');

        let html = '';
        for (let imp of imports.slice(0, 10)) { // Show last 10 imports
            const dateRange = imp.mollie_from_date && imp.mollie_to_date ?
                imp.mollie_from_date + ' to ' + imp.mollie_to_date : 'N/A';

            let statusClass = '';
            if (imp.import_status === 'Completed') statusClass = 'success';
            else if (imp.import_status === 'Failed') statusClass = 'danger';
            else if (imp.import_status === 'In Progress') statusClass = 'info';
            else statusClass = 'default';

            html += '<tr>';
            html += '<td>' + (imp.descriptive_name || imp.name) + '</td>';
            html += '<td>' + dateRange + '</td>';
            html += '<td><span class="label label-' + statusClass + '">' + imp.import_status + '</span></td>';
            html += '<td>' + (imp.transactions_created || 0) + ' created, ' + (imp.transactions_skipped || 0) + ' skipped</td>';
            html += '<td><a href="/app/mt940-import/' + imp.name + '" class="btn btn-xs btn-default">View</a></td>';
            html += '</tr>';
        }

        historyBody.innerHTML = html;
        historySection.style.display = 'block';
    }
});
</script>

{% endblock %}
