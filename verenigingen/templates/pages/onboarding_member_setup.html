{% extends "templates/web.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block page_content %}
<div class="container">
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="page-header">
                <h1>üë• Member Setup</h1>
                <p class="lead">Get started with membership management</p>
            </div>

            <!-- Status Overview -->
            <div class="row">
                <div class="col-md-4">
                    <div class="panel panel-info">
                        <div class="panel-body text-center">
                            <h3>{{ member_count }}</h3>
                            <p>Current Members</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-success">
                        <div class="panel-body text-center">
                            <h3>{{ test_members|length }}</h3>
                            <p>Test Members</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setup Options -->
            <div class="row">
                <!-- Manual Member Creation -->
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-header">
                            <h3 style="margin: 15px;">‚úèÔ∏è Manual Setup</h3>
                        </div>
                        <div class="panel-body">
                            <p>Create members and applications manually to understand the process.</p>
                            
                            {% if not has_membership_types %}
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è First step:</strong> You need to create Membership Types before creating members.
                            </div>
                            <div class="mb-3">
                                <a href="/app/membership-type/new-membership-type-1" class="btn btn-warning">
                                    <i class="fa fa-plus"></i> Create Membership Type First
                                </a>
                            </div>
                            {% else %}
                            <div class="alert alert-success">
                                <strong>‚úÖ Ready:</strong> You have {{ membership_types|length }} membership types configured.
                            </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                <a href="/app/member/new-member-1" class="btn btn-primary">
                                    <i class="fa fa-user-plus"></i> Create New Member
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Data Generation -->
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-header">
                            <h3 style="margin: 15px;">üöÄ Quick Setup with Test Data</h3>
                        </div>
                        <div class="panel-body">
                            <p>Generate realistic test members to explore the system quickly.</p>
                            
                            {% if has_test_data %}
                            <div class="alert alert-info">
                                <h5>üìã Current Test Members:</h5>
                                <ul style="margin-bottom: 10px;">
                                    {% for member in test_members[:5] %}
                                    <li><strong>{{ member.full_name }}</strong> - {{ member.status }}</li>
                                    {% endfor %}
                                    {% if test_members|length > 5 %}
                                    <li><em>... and {{ test_members|length - 5 }} more</em></li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                <button id="generate-test-btn" class="btn btn-success btn-lg">
                                    <i class="fa fa-magic"></i> Generate Test Members
                                </button>
                            </div>
                            
                            {% if has_test_data %}
                            <div class="mt-2">
                                <button id="refresh-status-btn" class="btn btn-info">
                                    <i class="fa fa-refresh"></i> Refresh Status
                                </button>
                                <button id="set-pending-btn" class="btn btn-primary">
                                    <i class="fa fa-clock-o"></i> Set as Pending Applications
                                </button>
                                <button id="cleanup-test-btn" class="btn btn-warning">
                                    <i class="fa fa-trash"></i> Clean Up Test Data
                                </button>
                            </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                <h5>Test data includes:</h5>
                                <ul>
                                    <li><strong>Noa Brouwer</strong> (Young member from Nijmegen) - Pending approval</li>
                                    <li><strong>Jan van den Berg</strong> (Utrecht member) - Pending approval</li>
                                    <li><strong>Sophie Jansen</strong> (Amsterdam member) - Pending approval</li>
                                    <li><strong>Eva Mulder</strong> (Rotterdam member) - Pending approval</li>
                                </ul>
                                <p><small><em>All test members are created with "Pending" application status so you can test the member approval workflow.</em></small></p>
                            </div>

                            <div id="test-result-message" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="panel panel-default">
                <div class="panel-header">
                    <h3 style="margin: 15px;">üìã Next Steps</h3>
                </div>
                <div class="panel-body">
                    <p>After creating members or applications, you can:</p>
                    <ul>
                        <li><strong>Manage Members:</strong> Visit <a href="/app/member">Member List</a></li>
                        <li><strong>Set up Chapters:</strong> Create geographic regions in <a href="/app/chapter">Chapter List</a></li>
                        <li><strong>Create Teams:</strong> Organize volunteers in <a href="/app/team">Team List</a></li>
                        <li><strong>Create Memberships:</strong> Link members to membership types in <a href="/app/membership">Membership List</a></li>
                    </ul>
                    
                    <div class="mt-3">
                        <a href="/app/verenigingen" class="btn btn-default">
                            <i class="fa fa-arrow-left"></i> Back to Verenigingen Workspace
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Generate test applications
    $('#generate-test-btn').click(function() {
        var btn = $(this);
        var originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Generating...');
        
        frappe.call({
            method: 'verenigingen.templates.pages.onboarding_member_setup.generate_test_applications',
            callback: function(r) {
                if (r.message && r.message.success) {
                    $('#test-result-message').html(
                        '<div class="alert alert-success">' +
                        '<h4>‚úÖ Test Applications Generated!</h4>' +
                        r.message.message +
                        '<hr>' +
                        '<a href="/app/member" class="btn btn-primary">View Members</a> ' +
                        '<a href="/app/membership" class="btn btn-default">View Memberships</a>' +
                        '</div>'
                    );
                    
                    // Refresh page after 3 seconds to show updated counts
                    setTimeout(function() {
                        window.location.reload();
                    }, 3000);
                } else {
                    $('#test-result-message').html(
                        '<div class="alert alert-danger">' +
                        '<h4>‚ùå Generation Failed</h4>' +
                        '<p>' + (r.message ? r.message.message : 'Unknown error occurred') + '</p>' +
                        '</div>'
                    );
                    btn.prop('disabled', false).html(originalText);
                }
            },
            error: function() {
                $('#test-result-message').html(
                    '<div class="alert alert-danger">' +
                    '<h4>‚ùå Error</h4>' +
                    '<p>Failed to generate test applications. Please try again.</p>' +
                    '</div>'
                );
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Refresh status
    $('#refresh-status-btn').click(function() {
        var btn = $(this);
        var originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Loading...');
        
        frappe.call({
            method: 'verenigingen.templates.pages.onboarding_member_setup.get_test_status',
            callback: function(r) {
                if (r.message) {
                    var msg = '<div class="alert alert-info">';
                    msg += '<h5>üìä Test Applications Status:</h5>';
                    msg += '<ul>';
                    for (var status in r.message.by_status) {
                        msg += '<li><strong>' + status + ':</strong> ' + r.message.by_status[status] + '</li>';
                    }
                    msg += '</ul>';
                    msg += '<p>Total: ' + r.message.total + ' test applications</p>';
                    msg += '</div>';
                    
                    $('#test-result-message').html(msg);
                }
                btn.prop('disabled', false).html(originalText);
            },
            error: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Set members to pending status
    $('#set-pending-btn').click(function() {
        var btn = $(this);
        var originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Updating...');
        
        frappe.call({
            method: 'verenigingen.templates.pages.onboarding_member_setup.update_test_members_to_pending',
            callback: function(r) {
                if (r.message && r.message.success) {
                    $('#test-result-message').html(
                        '<div class="alert alert-success">' +
                        '<h4>‚úÖ Members Updated</h4>' +
                        '<p>' + r.message.message + '</p>' +
                        '<p>Test members now have "Pending" application status and can be used to test the approval workflow.</p>' +
                        '</div>'
                    );
                    
                    // Refresh page after 2 seconds
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000);
                } else {
                    $('#test-result-message').html(
                        '<div class="alert alert-danger">' +
                        '<h4>‚ùå Update Failed</h4>' +
                        '<p>' + (r.message ? r.message.message : 'Unknown error occurred') + '</p>' +
                        '</div>'
                    );
                }
                btn.prop('disabled', false).html(originalText);
            },
            error: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Cleanup test data
    $('#cleanup-test-btn').click(function() {
        if (!confirm('Are you sure you want to delete all test applications?')) {
            return;
        }
        
        var btn = $(this);
        var originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Cleaning...');
        
        frappe.call({
            method: 'verenigingen.templates.pages.onboarding_member_setup.cleanup_test_data',
            callback: function(r) {
                if (r.message && r.message.success) {
                    $('#test-result-message').html(
                        '<div class="alert alert-warning">' +
                        '<h4>üóëÔ∏è Cleanup Complete</h4>' +
                        '<p>' + r.message.message + '</p>' +
                        '</div>'
                    );
                    
                    // Refresh page after 2 seconds
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000);
                } else {
                    $('#test-result-message').html(
                        '<div class="alert alert-danger">' +
                        '<h4>‚ùå Cleanup Failed</h4>' +
                        '<p>' + (r.message ? r.message.message : 'Unknown error occurred') + '</p>' +
                        '</div>'
                    );
                }
                btn.prop('disabled', false).html(originalText);
            },
            error: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });
});
</script>
{% endblock %}