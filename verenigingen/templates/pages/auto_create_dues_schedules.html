{% extends "templates/web.html" %}

{% block page_content %}
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <h1>{{ _("Auto-Create Missing Dues Schedules") }}</h1>
            <p class="text-muted">
                {{ _("This tool helps you create dues schedules for members who have an active membership with a membership type but no billing plan.") }}
            </p>

            <div class="alert alert-info">
                <h5>{{ _("How it works:") }}</h5>
                <ul>
                    <li>{{ _("Identifies members with active memberships but no active dues schedule") }}</li>
                    <li>{{ _("Creates dues schedules based on membership type settings") }}</li>
                    <li>{{ _("Sends email notifications upon completion") }}</li>
                    <li>{{ _("Runs automatically daily at 2 AM server time") }}</li>
                </ul>
            </div>

            <div class="mt-4">
                <h3>{{ _("Manual Execution") }}</h3>
                <div class="card">
                    <div class="card-body">
                        <p>{{ _("Click the button below to manually run the dues schedule creation process.") }}</p>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="preview-mode" checked>
                            <label class="form-check-label" for="preview-mode">
                                {{ _("Preview Mode (shows what would be created without making changes)") }}
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="send-emails">
                            <label class="form-check-label" for="send-emails">
                                {{ _("Send email notifications") }}
                            </label>
                        </div>

                        <button class="btn btn-primary" id="run-auto-create">
                            <i class="fa fa-play"></i> {{ _("Run Auto-Create Process") }}
                        </button>

                        <button class="btn btn-secondary ml-2" id="check-members">
                            <i class="fa fa-search"></i> {{ _("Check Members Without Schedules") }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4" id="results-section" style="display: none;">
                <h3>{{ _("Results") }}</h3>
                <div class="card">
                    <div class="card-body">
                        <div id="results-content"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4" id="members-list-section" style="display: none;">
                <h3>{{ _("Members Without Dues Schedules") }}</h3>
                <div class="card">
                    <div class="card-body">
                        <div id="members-list-content"></div>

                        <div class="mt-3" id="create-selected-section" style="display: none;">
                            <button class="btn btn-success" id="create-selected">
                                <i class="fa fa-check"></i> {{ _("Create Schedules for Selected Members") }}
                            </button>
                            <button class="btn btn-outline-secondary ml-2" id="select-all">
                                {{ _("Select All") }}
                            </button>
                            <button class="btn btn-outline-secondary ml-2" id="select-none">
                                {{ _("Select None") }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
frappe.ready(function() {
    console.log('Auto-create dues schedules page loaded');
    console.log('Frappe available:', typeof frappe !== 'undefined');

    // Run auto-create process
    $('#run-auto-create').click(function() {
        console.log('Run auto-create button clicked');
        var previewMode = $('#preview-mode').is(':checked');
        var sendEmails = $('#send-emails').is(':checked');
        var $btn = $(this);

        $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Processing...');
        $('#results-section').hide();

        frappe.call({
            method: 'verenigingen.utils.dues_schedule_auto_creator.auto_create_missing_dues_schedules',
            args: {
                preview_mode: previewMode,
                send_emails: sendEmails
            },
            callback: function(r) {
                $btn.prop('disabled', false).html('<i class="fa fa-play"></i> {{ _("Run Auto-Create Process") }}');

                if (r.message) {
                    displayResults(r.message, previewMode);
                }
            },
            error: function(r) {
                $btn.prop('disabled', false).html('<i class="fa fa-play"></i> {{ _("Run Auto-Create Process") }}');
                frappe.msgprint({
                    title: __('Error'),
                    message: r.message || __('An error occurred while running the process'),
                    indicator: 'red'
                });
            }
        });
    });

    // Check members without schedules
    $('#check-members').click(function() {
        var $btn = $(this);
        $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Checking...');
        $('#members-list-section').hide();

        frappe.call({
            method: 'verenigingen.utils.dues_schedule_auto_creator.get_members_without_dues_schedules',
            callback: function(r) {
                $btn.prop('disabled', false).html('<i class="fa fa-search"></i> {{ _("Check Members Without Schedules") }}');

                if (r.message) {
                    displayMembersList(r.message);
                }
            },
            error: function(r) {
                $btn.prop('disabled', false).html('<i class="fa fa-search"></i> {{ _("Check Members Without Schedules") }}');
                frappe.msgprint({
                    title: __('Error'),
                    message: r.message || __('An error occurred while checking members'),
                    indicator: 'red'
                });
            }
        });
    });

    // Create schedules for selected members
    $('#create-selected').click(function() {
        var selectedMembers = [];
        $('.member-checkbox:checked').each(function() {
            selectedMembers.push($(this).data('member'));
        });

        if (selectedMembers.length === 0) {
            frappe.msgprint(__('Please select at least one member'));
            return;
        }

        var $btn = $(this);
        $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Creating...');

        frappe.call({
            method: 'verenigingen.utils.dues_schedule_auto_creator.create_dues_schedules_for_members',
            args: {
                members: selectedMembers,
                send_emails: $('#send-emails').is(':checked')
            },
            callback: function(r) {
                $btn.prop('disabled', false).html('<i class="fa fa-check"></i> {{ _("Create Schedules for Selected Members") }}');

                if (r.message) {
                    displayResults(r.message, false);
                    // Refresh the members list
                    $('#check-members').click();
                }
            },
            error: function(r) {
                $btn.prop('disabled', false).html('<i class="fa fa-check"></i> {{ _("Create Schedules for Selected Members") }}');
                frappe.msgprint({
                    title: __('Error'),
                    message: r.message || __('An error occurred while creating schedules'),
                    indicator: 'red'
                });
            }
        });
    });

    // Select all/none buttons
    $('#select-all').click(function() {
        $('.member-checkbox').prop('checked', true);
    });

    $('#select-none').click(function() {
        $('.member-checkbox').prop('checked', false);
    });

    function displayResults(result, isPreview) {
        var html = '<h5>' + (isPreview ? __('Preview Results') : __('Execution Results')) + '</h5>';

        if (isPreview) {
            html += '<div class="alert alert-warning">' + __('This is a preview. No changes were made.') + '</div>';
        }

        html += '<div class="row mb-3">';
        html += '<div class="col-md-4"><strong>' + __('Total Members Found:') + '</strong> ' + result.total_members + '</div>';
        html += '<div class="col-md-4"><strong>' + __('Schedules Created:') + '</strong> ' + result.created_count + '</div>';
        html += '<div class="col-md-4"><strong>' + __('Errors:') + '</strong> ' + result.error_count + '</div>';
        html += '</div>';

        if (result.created_schedules && result.created_schedules.length > 0) {
            html += '<h6 class="mt-3">' + __('Created Schedules:') + '</h6>';
            html += '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>' + __('Member') + '</th><th>' + __('Schedule') + '</th><th>' + __('Dues Rate') + '</th><th>' + __('Frequency') + '</th></tr></thead>';
            html += '<tbody>';

            result.created_schedules.forEach(function(schedule) {
                html += '<tr>';
                html += '<td>' + schedule.member_name + '</td>';
                html += '<td>' + (schedule.schedule_name || '-') + '</td>';
                html += '<td>' + frappe.format(schedule.dues_rate, {fieldtype: 'Currency'}) + '</td>';
                html += '<td>' + (schedule.billing_frequency || '-') + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
        }

        if (result.errors && result.errors.length > 0) {
            html += '<h6 class="mt-3 text-danger">' + __('Errors:') + '</h6>';
            html += '<ul class="text-danger">';
            result.errors.forEach(function(error) {
                html += '<li>' + error + '</li>';
            });
            html += '</ul>';
        }

        if (result.email_sent) {
            html += '<div class="alert alert-success mt-3">' + __('Email notification sent to administrators') + '</div>';
        }

        $('#results-content').html(html);
        $('#results-section').show();
    }

    function displayMembersList(members) {
        var html = '';

        if (members.length === 0) {
            html = '<div class="alert alert-success">' + __('All members with active memberships have dues schedules!') + '</div>';
            $('#create-selected-section').hide();
        } else {
            html = '<p>' + __('Found {0} members without dues schedules:', [members.length]) + '</p>';
            html += '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr>';
            html += '<th width="40"><input type="checkbox" id="check-all-members"></th>';
            html += '<th>' + __('Member ID') + '</th>';
            html += '<th>' + __('Member Name') + '</th>';
            html += '<th>' + __('Membership Type') + '</th>';
            html += '<th>' + __('Status') + '</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            members.forEach(function(member) {
                html += '<tr>';
                html += '<td><input type="checkbox" class="member-checkbox" data-member="' + member.name + '"></td>';
                html += '<td>' + (member.member_id || '-') + '</td>';
                html += '<td><a href="/app/member/' + member.name + '" target="_blank">' + member.full_name + '</a></td>';
                html += '<td>' + (member.membership_type || '-') + '</td>';
                html += '<td><span class="badge badge-' + (member.status === 'Active' ? 'success' : 'secondary') + '">' + member.status + '</span></td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            $('#create-selected-section').show();
        }

        $('#members-list-content').html(html);
        $('#members-list-section').show();

        // Bind check all functionality
        $('#check-all-members').change(function() {
            $('.member-checkbox').prop('checked', $(this).is(':checked'));
        });
    }
});

</script>
{% endblock %}
