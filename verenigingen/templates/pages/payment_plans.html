{% extends "templates/web.html" %}

{% block title %}Payment Plans{% endblock %}

{% block head_include %}
<style>
.payment-plan-card {
    border: 1px solid #e3e3e3;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: white;
}

.payment-plan-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.status-active { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }
.status-completed { background: #cce5ff; color: #004085; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-suspended { background: #ffeaa7; color: #d63031; }

.installment-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.installment-table th,
.installment-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.installment-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.progress-bar {
    background: #e9ecef;
    border-radius: 4px;
    height: 20px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-bar-fill {
    background: var(--brand-primary, #28a745);
    height: 100%;
    transition: width 0.3s ease;
}

.payment-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    display: none;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
}

.btn-primary {
    background: var(--brand-primary, #007bff);
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.alert {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

@media (max-width: 768px) {
    .payment-plan-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .installment-table {
        font-size: 14px;
    }

    .installment-table th,
    .installment-table td {
        padding: 6px 8px;
    }
}
</style>
{% endblock %}

{% block page_content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Payment Plans</h1>

            <div id="alert-container"></div>

            <!-- Request New Payment Plan Button -->
            <div class="text-right" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showPaymentPlanRequestForm()">
                    Request New Payment Plan
                </button>
            </div>

            <!-- Payment Plan Request Form -->
            <div id="payment-plan-request-form" class="payment-form">
                <h3>Request Payment Plan</h3>
                <form id="new-payment-plan-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="total_amount">Total Amount (€)</label>
                                <input type="number" id="total_amount" name="total_amount"
                                       step="0.01" min="10" max="1000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="installments">Number of Installments</label>
                                <select id="installments" name="installments" required>
                                    <option value="2">2 payments</option>
                                    <option value="3" selected>3 payments</option>
                                    <option value="4">4 payments</option>
                                    <option value="6">6 payments</option>
                                    <option value="12">12 payments</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="frequency">Payment Frequency</label>
                                <select id="frequency" name="frequency" required>
                                    <option value="Weekly">Weekly</option>
                                    <option value="Bi-weekly">Bi-weekly</option>
                                    <option value="Monthly" selected>Monthly</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Installment Amount</label>
                                <div id="installment-preview" style="padding: 8px; background: #e9ecef; border-radius: 4px;">
                                    €0.00 per payment
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reason">Reason for Payment Plan (optional)</label>
                        <textarea id="reason" name="reason" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                  placeholder="Please explain why you need a payment plan (e.g., temporary financial difficulty, prefer smaller payments, etc.)"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">Submit Request</button>
                        <button type="button" class="btn btn-secondary" onclick="hidePaymentPlanRequestForm()">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Payment Plans List -->
            <div id="payment-plans-container">
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading payment plans...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let memberPaymentPlans = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadPaymentPlans();
    setupFormHandlers();
});

function setupFormHandlers() {
    // Payment plan request form
    document.getElementById('new-payment-plan-form').addEventListener('submit', handlePaymentPlanRequest);

    // Update installment preview when values change
    document.getElementById('total_amount').addEventListener('input', updateInstallmentPreview);
    document.getElementById('installments').addEventListener('change', updateInstallmentPreview);
}

function loadPaymentPlans() {
    frappe.call({
        method: 'verenigingen.api.payment_plan_management.get_member_payment_plans',
        callback: function(response) {
            if (response.message && response.message.success) {
                memberPaymentPlans = response.message.payment_plans;
                renderPaymentPlans();
            } else {
                showAlert('error', response.message?.error || 'Failed to load payment plans');
                document.getElementById('payment-plans-container').innerHTML =
                    '<div class="alert alert-danger">Failed to load payment plans</div>';
            }
        },
        error: function() {
            showAlert('error', 'Network error while loading payment plans');
        }
    });
}

function renderPaymentPlans() {
    const container = document.getElementById('payment-plans-container');

    if (memberPaymentPlans.length === 0) {
        container.innerHTML = `
            <div class="text-center" style="padding: 40px;">
                <h4>No Payment Plans</h4>
                <p>You don't have any payment plans yet. Click "Request New Payment Plan" to get started.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = memberPaymentPlans.map(plan => renderPaymentPlan(plan)).join('');
}

function renderPaymentPlan(plan) {
    const progress = plan.total_amount > 0 ? (plan.total_paid / plan.total_amount) * 100 : 0;
    const statusClass = `status-${plan.status.toLowerCase().replace(' ', '-')}`;

    return `
        <div class="payment-plan-card">
            <div class="payment-plan-header">
                <div>
                    <h4 style="margin: 0;">${plan.name}</h4>
                    <small style="color: #666;">Created: ${formatDate(plan.start_date)}</small>
                </div>
                <span class="status-badge ${statusClass}">${plan.status}</span>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <p><strong>Total Amount:</strong> €${plan.total_amount.toFixed(2)}</p>
                    <p><strong>Paid:</strong> €${plan.total_paid.toFixed(2)}</p>
                    <p><strong>Remaining:</strong> €${plan.remaining_balance.toFixed(2)}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Installment:</strong> €${plan.installment_amount.toFixed(2)} ${plan.frequency.toLowerCase()}</p>
                    <p><strong>Next Payment Request:</strong> ${plan.next_payment_date ? formatDate(plan.next_payment_date) : 'N/A'}</p>
                    ${plan.consecutive_missed_payments > 0 ?
                        `<p style="color: #d63031;"><strong>Missed Payments:</strong> ${plan.consecutive_missed_payments}</p>` : ''}
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: ${progress}%"></div>
            </div>
            <small style="color: #666;">${progress.toFixed(1)}% complete</small>

            ${renderInstallmentsTable(plan)}

            ${plan.status === 'Active' && plan.next_payment_date ?
                `<button class="btn btn-primary" onclick="showPaymentForm('${plan.name}')">Make Payment</button>` : ''}
        </div>
    `;
}

function renderInstallmentsTable(plan) {
    if (!plan.installments || plan.installments.length === 0) {
        return '';
    }

    return `
        <table class="installment-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Due Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Payment Date</th>
                </tr>
            </thead>
            <tbody>
                ${plan.installments.map(inst => `
                    <tr>
                        <td>${inst.installment_number}</td>
                        <td>${formatDate(inst.due_date)}</td>
                        <td>€${inst.amount.toFixed(2)}</td>
                        <td><span class="status-badge status-${inst.status.toLowerCase()}">${inst.status}</span></td>
                        <td>${inst.payment_date ? formatDate(inst.payment_date) : '-'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function showPaymentPlanRequestForm() {
    document.getElementById('payment-plan-request-form').style.display = 'block';
    updateInstallmentPreview();
}

function hidePaymentPlanRequestForm() {
    document.getElementById('payment-plan-request-form').style.display = 'none';
    document.getElementById('new-payment-plan-form').reset();
}

function updateInstallmentPreview() {
    const totalAmount = parseFloat(document.getElementById('total_amount').value) || 0;
    const installments = parseInt(document.getElementById('installments').value) || 1;
    const installmentAmount = totalAmount / installments;

    document.getElementById('installment-preview').textContent =
        `€${installmentAmount.toFixed(2)} per payment`;
}

function handlePaymentPlanRequest(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());

    // Validate
    if (parseFloat(data.total_amount) < 10) {
        showAlert('error', 'Total amount must be at least €10');
        return;
    }

    // Submit request
    frappe.call({
        method: 'verenigingen.api.payment_plan_management.request_payment_plan',
        args: {
            member: null, // Will be determined from current user
            total_amount: parseFloat(data.total_amount),
            preferred_installments: parseInt(data.installments),
            preferred_frequency: data.frequency,
            reason: data.reason
        },
        callback: function(response) {
            if (response.message && response.message.success) {
                showAlert('success', response.message.message);
                hidePaymentPlanRequestForm();
                loadPaymentPlans(); // Reload to show new request
            } else {
                showAlert('error', response.message?.error || 'Failed to submit payment plan request');
            }
        },
        error: function() {
            showAlert('error', 'Network error while submitting request');
        }
    });
}

function showPaymentForm(planId) {
    // This would show a payment form - for now, show an alert
    showAlert('info', 'Payment recording feature coming soon. Please contact support to record payments.');
}

function showAlert(type, message) {
    const alertContainer = document.getElementById('alert-container');
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';

    alertContainer.innerHTML = `
        <div class="alert ${alertClass}">
            ${message}
            <button type="button" style="float: right; background: none; border: none; font-size: 16px;" onclick="this.parentElement.remove()">×</button>
        </div>
    `;

    // Auto-hide after 5 seconds
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
}

// Initialize frappe if not available
if (typeof frappe === 'undefined') {
    window.frappe = {
        call: function(options) {
            fetch('/api/method/' + options.method, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Frappe-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                },
                body: JSON.stringify(options.args || {})
            })
            .then(response => response.json())
            .then(data => {
                if (options.callback) options.callback({message: data.message});
            })
            .catch(error => {
                if (options.error) options.error(error);
            });
        }
    };
}
</script>
{% endblock %}
