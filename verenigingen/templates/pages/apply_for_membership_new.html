{% extends "templates/web.html" %}

{% block title %}{{ _("Apply for Membership") }} - TailwindCSS{% endblock %}

{% block style %}
<link href="/assets/verenigingen/css/tailwind.css" rel="stylesheet">
{% endblock %}

{% block page_content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Organization Logo & Header -->
        <div class="organization-logo animate-fade-in">
            <img src="/assets/verenigingen/images/logo.png" alt="Organization Logo" class="logo-img">
        </div>
        
        <div class="page-header animate-slide-up">
            <h1 class="page-title">{{ _("Become a Member") }}</h1>
            <p class="page-subtitle">{{ _("Join our association and become part of our community dedicated to making a positive impact!") }}</p>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-container animate-slide-up">
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 16.67%" id="form-progress"></div>
            </div>
            <div class="progress-steps">
                <span class="progress-step active" data-step="1">{{ _("Personal Info") }}</span>
                <span class="progress-step" data-step="2">{{ _("Address") }}</span>
                <span class="progress-step" data-step="3">{{ _("Membership") }}</span>
                <span class="progress-step" data-step="4">{{ _("Volunteer") }}</span>
                <span class="progress-step" data-step="5">{{ _("Payment") }}</span>
                <span class="progress-step" data-step="6">{{ _("Confirm") }}</span>
            </div>
        </div>
        
        <!-- Multi-Step Form -->
        <form id="membership-application-form" class="space-y-6" onsubmit="return false;">
            
            <!-- Step 1: Personal Information -->
            <div class="form-step active" data-step="1">
                <div class="form-card">
                    <div class="form-header">
                        <h3>{{ _("Personal Information") }}</h3>
                    </div>
                    <div class="form-body">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="input-group">
                                <label for="first_name" class="input-label required">{{ _("Preferred Name") }}</label>
                                <input type="text" class="form-input" id="first_name" name="first_name" required
                                       placeholder="{{ _('Enter your preferred name') }}">
                                <div class="text-red-500 text-sm hidden" id="first_name_error">{{ _("This field is required") }}</div>
                            </div>
                            
                            <div class="input-group">
                                <label for="middle_name" class="input-label">{{ _("Middle Name") }}</label>
                                <input type="text" class="form-input" id="middle_name" name="middle_name"
                                       placeholder="{{ _('Optional') }}">
                            </div>
                            
                            <div class="input-group">
                                <label for="last_name" class="input-label required">{{ _("Last Name") }}</label>
                                <input type="text" class="form-input" id="last_name" name="last_name" required
                                       placeholder="{{ _('Enter your last name') }}">
                                <div class="text-red-500 text-sm hidden" id="last_name_error">{{ _("This field is required") }}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="input-group">
                                <label for="email" class="input-label required">{{ _("Email Address") }}</label>
                                <input type="email" class="form-input" id="email" name="email" required
                                       placeholder="{{ _('your.email@example.com') }}">
                                <div class="text-red-500 text-sm hidden" id="email_error">{{ _("Please enter a valid email address") }}</div>
                            </div>
                            
                            <div class="input-group">
                                <label for="mobile_no" class="input-label">{{ _("Mobile Number") }}</label>
                                <input type="tel" class="form-input" id="mobile_no" name="mobile_no"
                                       placeholder="{{ _('Optional') }}">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="input-group">
                                <label for="birth_date" class="input-label">{{ _("Date of Birth") }}</label>
                                <input type="date" class="form-input" id="birth_date" name="birth_date">
                            </div>
                            
                            <div class="input-group">
                                <label for="pronouns" class="input-label">{{ _("Pronouns") }}</label>
                                <select class="form-input" id="pronouns" name="pronouns">
                                    <option value="">{{ _("Select pronouns") }}</option>
                                    <option value="he/him">{{ _("He/Him") }}</option>
                                    <option value="she/her">{{ _("She/Her") }}</option>
                                    <option value="they/them">{{ _("They/Them") }}</option>
                                    <option value="other">{{ _("Other") }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Address Information -->
            <div class="form-step" data-step="2">
                <div class="form-card">
                    <div class="form-header">
                        <h3>{{ _("Address Information") }}</h3>
                    </div>
                    <div class="form-body">
                        <div class="input-group">
                            <label for="address_line1" class="input-label required">{{ _("Street Address") }}</label>
                            <input type="text" class="form-input" id="address_line1" name="address_line1" required
                                   placeholder="{{ _('Street name and house number') }}">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="input-group">
                                <label for="postal_code" class="input-label required">{{ _("Postal Code") }}</label>
                                <input type="text" class="form-input" id="postal_code" name="postal_code" required
                                       placeholder="{{ _('1234 AB') }}">
                            </div>
                            
                            <div class="input-group">
                                <label for="city" class="input-label required">{{ _("City") }}</label>
                                <input type="text" class="form-input" id="city" name="city" required
                                       placeholder="{{ _('City name') }}">
                            </div>
                            
                            <div class="input-group">
                                <label for="country" class="input-label required">{{ _("Country") }}</label>
                                <select class="form-input" id="country" name="country" required>
                                    <option value="">{{ _("Select country") }}</option>
                                    <option value="Netherlands">{{ _("Netherlands") }}</option>
                                    <option value="Belgium">{{ _("Belgium") }}</option>
                                    <option value="Germany">{{ _("Germany") }}</option>
                                    <option value="Other">{{ _("Other") }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Membership Type -->
            <div class="form-step" data-step="3">
                <div class="form-card">
                    <div class="form-header">
                        <h3>{{ _("Choose Your Membership") }}</h3>
                    </div>
                    <div class="form-body">
                        <!-- Chapter Selection -->
                        <div id="chapter-selection" class="mb-6" style="display: none;">
                            <h5 class="input-label">{{ _("Chapter Selection") }} <small class="text-gray-500">({{ _("Optional") }})</small></h5>
                            <div id="suggested-chapter" class="alert-success mb-4" style="display: none;">
                                <p>{{ _("Based on your postal code, we suggest:") }} <strong id="suggested-chapter-name"></strong></p>
                                <button type="button" class="btn-primary mt-2" id="accept-suggestion">
                                    {{ _("Join this chapter") }}
                                </button>
                            </div>
                            
                            <div class="input-group">
                                <label for="selected_chapter" class="input-label">{{ _("Which chapter would you like to join?") }}</label>
                                <select class="form-input" id="selected_chapter" name="selected_chapter">
                                    <option value="">{{ _("Select a chapter...") }}</option>
                                </select>
                                <p class="text-sm text-gray-600 mt-1">
                                    {{ _("Choose the chapter you'd like to be part of. Leave blank to be assigned automatically based on your location.") }}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Membership Type Selection -->
                        <h5 class="input-label required">{{ _("Membership Type") }}</h5>
                        <div id="membership-types" class="card-grid">
                            <div class="text-center">
                                <div class="text-gray-500">{{ _("Loading membership types...") }}</div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="membership_type" name="membership_type" required>
                        
                        <!-- Custom Contribution Amount -->
                        <div class="input-group mt-6" id="custom-contribution" style="display: none;">
                            <label for="custom_amount" class="input-label">{{ _("Custom Annual Contribution Amount") }}</label>
                            <div class="flex items-center">
                                <span class="text-gray-500 mr-2">‚Ç¨</span>
                                <input type="number" class="form-input" id="custom_amount" name="custom_amount" 
                                       min="10" step="0.01" placeholder="25.00">
                            </div>
                            <p class="text-sm text-gray-600 mt-1">{{ _("Minimum contribution is ‚Ç¨10. Suggested amount is ‚Ç¨25.") }}</p>
                        </div>
                        
                        <div class="text-red-500 text-sm hidden" id="membership_type_error">{{ _("Please select a membership type") }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Volunteer Information -->
            <div class="form-step" data-step="4">
                <div class="form-card">
                    <div class="form-header">
                        <h3>{{ _("Volunteer Interests") }}</h3>
                    </div>
                    <div class="form-body">
                        <div class="input-group">
                            <div class="flex items-center space-x-3 mb-4">
                                <input type="checkbox" id="interested_in_volunteering" name="interested_in_volunteering" class="form-input w-auto">
                                <label for="interested_in_volunteering" class="input-label">
                                    {{ _("I'm interested in volunteering with the association") }}
                                </label>
                            </div>
                        </div>
                        
                        <div id="volunteer-details" style="display: none;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div class="input-group">
                                    <label for="volunteer_availability" class="input-label">{{ _("Availability") }}</label>
                                    <select class="form-input" id="volunteer_availability" name="volunteer_availability">
                                        <option value="">{{ _("Select...") }}</option>
                                        <option value="Occasional">{{ _("Occasional (Few times a year)") }}</option>
                                        <option value="Monthly">{{ _("Monthly") }}</option>
                                        <option value="Weekly">{{ _("Weekly") }}</option>
                                        <option value="Project-based">{{ _("Project-based") }}</option>
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <label for="volunteer_experience_level" class="input-label">{{ _("Experience Level") }}</label>
                                    <select class="form-input" id="volunteer_experience_level" name="volunteer_experience_level">
                                        <option value="">{{ _("Select...") }}</option>
                                        <option value="Beginner">{{ _("Beginner") }}</option>
                                        <option value="Intermediate">{{ _("Intermediate") }}</option>
                                        <option value="Experienced">{{ _("Experienced") }}</option>
                                        <option value="Expert">{{ _("Expert") }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group" id="volunteer-areas" style="display: none;">
                            <label class="input-label">{{ _("Which areas interest you?") }}</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="volunteer_areas[]" value="events" class="form-input w-auto">
                                    <span>{{ _("Event Organization") }}</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="volunteer_areas[]" value="communications" class="form-input w-auto">
                                    <span>{{ _("Communications") }}</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="volunteer_areas[]" value="fundraising" class="form-input w-auto">
                                    <span>{{ _("Fundraising") }}</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" name="volunteer_areas[]" value="outreach" class="form-input w-auto">
                                    <span>{{ _("Community Outreach") }}</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="volunteer_skills" class="input-label">{{ _("Skills & Experience") }}</label>
                            <textarea class="form-input" id="volunteer_skills" name="volunteer_skills" rows="2"
                                      placeholder="{{ _('What skills or experience do you have that could help our organization?') }}"></textarea>
                        </div>
                        
                        <div class="input-group">
                            <label for="volunteer_availability" class="input-label">{{ _("Availability") }}</label>
                            <textarea class="form-input" id="volunteer_availability" name="volunteer_availability" rows="2"
                                      placeholder="{{ _('When are you typically available? (e.g., weekends, evenings, specific days)') }}"></textarea>
                        </div>
                        
                        <div class="input-group">
                            <label for="volunteer_comments" class="input-label">{{ _("Additional Comments") }}</label>
                            <textarea class="form-input" id="volunteer_comments" name="volunteer_comments" rows="3"
                                      placeholder="{{ _('Tell us about your motivation, special interests, or anything else you\'d like us to know...') }}"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Payment Information -->
            <div class="form-step" data-step="5">
                <div class="form-card">
                    <div class="form-header">
                        <h3>{{ _("Payment Information") }}</h3>
                    </div>
                    <div class="form-body">
                        <div class="alert-success mb-6">
                            <p class="font-medium mb-2">{{ _("Membership Fee Summary") }}</p>
                            <p class="text-sm" id="payment-summary">{{ _("Your selected membership fee will be displayed here.") }}</p>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label required">{{ _("Payment Method") }}</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="payment_method" value="bank_transfer" class="form-input w-auto" required>
                                    <span>{{ _("Bank Transfer") }}</span>
                                </label>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="payment_method" value="sepa_direct_debit" class="form-input w-auto" required>
                                    <span>{{ _("SEPA Direct Debit") }}</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="input-group" id="bank-details">
                            <label for="iban" class="input-label required">{{ _("IBAN") }}</label>
                            <input type="text" class="form-input" id="iban" name="iban"
                                   placeholder="{{ _('NL00 BANK 0000 0000 00') }}">
                            <p class="text-sm text-gray-600 mt-1" id="bank-details-description">{{ _("Your bank account details for payment matching and processing.") }}</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="input-group">
                                    <label for="account_holder_name" class="input-label required">{{ _("Account Holder Name") }}</label>
                                    <input type="text" class="form-input" id="account_holder_name" name="account_holder_name"
                                           placeholder="{{ _('Full name as on bank account') }}">
                                </div>
                                
                                <div class="input-group">
                                    <label for="bic" class="input-label">{{ _("BIC/SWIFT Code") }}</label>
                                    <input type="text" class="form-input" id="bic" name="bic"
                                           placeholder="{{ _('ABNANL2A (optional for Dutch banks)') }}">
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Step 6: Confirmation -->
            <div class="form-step" data-step="6">
                <div class="form-card">
                    <div class="form-header">
                        <h3>{{ _("Confirm Your Application") }}</h3>
                    </div>
                    <div class="form-body">
                        <div class="alert-success mb-6">
                            <p class="font-medium">{{ _("Please review your information before submitting.") }}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">{{ _("Personal Information") }}</h4>
                                <div class="space-y-2 text-sm">
                                    <p><span class="font-medium">{{ _("Name") }}:</span> <span id="confirm-name"></span></p>
                                    <p><span class="font-medium">{{ _("Email") }}:</span> <span id="confirm-email"></span></p>
                                    <p><span class="font-medium">{{ _("Phone") }}:</span> <span id="confirm-phone"></span></p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">{{ _("Address") }}</h4>
                                <div class="space-y-2 text-sm">
                                    <p><span class="font-medium">{{ _("Address") }}:</span> <span id="confirm-address"></span></p>
                                    <p><span class="font-medium">{{ _("City") }}:</span> <span id="confirm-city"></span></p>
                                    <p><span class="font-medium">{{ _("Country") }}:</span> <span id="confirm-country"></span></p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">{{ _("Membership") }}</h4>
                                <div class="space-y-2 text-sm">
                                    <p><span class="font-medium">{{ _("Type") }}:</span> <span id="confirm-membership-type"></span></p>
                                    <p><span class="font-medium">{{ _("Fee") }}:</span> <span id="confirm-membership-fee"></span></p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">{{ _("Payment") }}</h4>
                                <div class="space-y-2 text-sm">
                                    <p><span class="font-medium">{{ _("Method") }}:</span> <span id="confirm-payment-method"></span></p>
                                    <p><span class="font-medium">{{ _("Volunteering") }}:</span> <span id="confirm-volunteering"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" name="terms_accepted" class="form-input w-auto" required>
                                <span class="text-sm">{{ _("I agree to the membership terms and conditions") }}</span>
                            </label>
                        </div>
                        
                        <div class="input-group">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" name="privacy_accepted" class="form-input w-auto" required>
                                <span class="text-sm">{{ _("I agree to the privacy policy and data processing") }}</span>
                            </label>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-700">
                                {{ _("By submitting this application, you confirm that all information provided is accurate and complete. You will receive a confirmation email with payment instructions.") }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="flex justify-between pt-6">
                <button type="button" class="btn-secondary hidden" id="btn-prev">
                    ‚Üê {{ _("Previous") }}
                </button>
                
                <div class="ml-auto">
                    <button type="button" class="btn-primary" id="btn-next">
                        {{ _("Next") }} ‚Üí
                    </button>
                    <button type="submit" class="btn-success hidden" id="btn-submit">
                        {{ _("Submit Application") }}
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Success Message (Hidden by default) -->
        <div class="hidden" id="success-message">
            <div class="alert-success text-center">
                <div class="text-2xl mb-4">üéâ</div>
                <h3 class="text-xl font-semibold mb-2">{{ _("Application Submitted Successfully!") }}</h3>
                <p class="mb-4">{{ _("Thank you for applying to join our association. We'll review your application and get back to you soon.") }}</p>
                <p class="text-sm text-gray-600 mb-4">{{ _("You will receive a confirmation email shortly with your application details.") }}</p>
                <a href="/" class="btn-primary inline-block">{{ _("Return to Home") }}</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
class MembershipApplicationTailwind {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 6;
        this.formData = {};
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.setupVolunteerFields();
        this.setupPaymentFields();
        this.loadFormData();
        this.loadSavedData();
    }
    
    bindEvents() {
        // Navigation buttons
        const nextBtn = document.getElementById('btn-next');
        const prevBtn = document.getElementById('btn-prev');
        const submitBtn = document.getElementById('btn-submit');
        
        if (nextBtn) {
            nextBtn.addEventListener('click', (e) => {
                this.nextStep(e);
            });
        }
        
        if (prevBtn) {
            prevBtn.addEventListener('click', (e) => {
                this.prevStep(e);
            });
        }
        
        if (submitBtn) {
            submitBtn.addEventListener('click', (e) => this.submitForm(e));
        }
        
        // Auto-save functionality and validation
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('input', (e) => {
                this.autoSave(e);
                // Validate on input for immediate feedback
                if (e.target.type === 'date' || e.target.type === 'email') {
                    this.validateField(e);
                }
            });
            input.addEventListener('blur', (e) => this.validateField(e));
            input.addEventListener('change', (e) => this.validateField(e));
        });
    }
    
    loadFormData() {
        console.log('Loading form data from API...');
        
        // Load form data including membership types, chapters, countries
        fetch('/api/method/verenigingen.api.membership_application.get_application_form_data')
            .then(response => response.json())
            .then(result => {
                console.log('Form data loaded:', result);
                
                if (result.message) {
                    const data = result.message;
                    
                    // Populate countries
                    if (data.countries) {
                        const countrySelect = document.getElementById('country');
                        countrySelect.innerHTML = '<option value="">{{ _("Select country") }}</option>';
                        data.countries.forEach(country => {
                            const isSelected = country.name === 'Netherlands' ? ' selected' : '';
                            countrySelect.innerHTML += `<option value="${country.name}"${isSelected}>${country.name}</option>`;
                        });
                    }
                    
                    // Populate chapters if available
                    if (data.chapters && data.chapters.length > 0) {
                        const chapterSelect = document.getElementById('selected_chapter');
                        chapterSelect.innerHTML = '<option value="">{{ _("Select a chapter...") }}</option>';
                        data.chapters.forEach(chapter => {
                            chapterSelect.innerHTML += `<option value="${chapter.name}">${chapter.name}${chapter.region ? ' - ' + chapter.region : ''}</option>`;
                        });
                        document.getElementById('chapter-selection').style.display = 'block';
                    }
                    
                    // Populate membership types
                    if (data.membership_types) {
                        this.renderMembershipTypes(data.membership_types);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading form data:', error);
                this.renderFallbackMembershipTypes();
            });
    }
    
    renderMembershipTypes(membershipTypes) {
        const container = document.getElementById('membership-types');
        container.innerHTML = '';
        
        // Enhance membership types with custom amount support
        const enhancedTypes = membershipTypes.map(type => {
            const baseAmount = parseFloat(type.amount) || 50;
            return {
                ...type,
                allow_custom_amount: true,
                minimum_amount: Math.max(10, baseAmount * 0.5),
                maximum_amount: baseAmount * 5,
                suggested_amounts: [
                    { amount: baseAmount, label: "Standard" },
                    { amount: baseAmount * 1.5, label: "Supporter" },
                    { amount: baseAmount * 2, label: "Patron" },
                    { amount: baseAmount * 3, label: "Benefactor" }
                ]
            };
        });
        
        enhancedTypes.forEach(type => {
            const card = this.createMembershipCard(type);
            container.appendChild(card);
        });
        
        this.setupMembershipSelection();
    }
    
    createMembershipCard(type) {
        const card = document.createElement('div');
        card.className = 'membership-type-card';
        card.dataset.type = type.name;
        card.dataset.amount = type.amount;
        
        const subscriptionPeriod = type.subscription_period || 'Monthly';
        
        card.innerHTML = `
            <div class="membership-type-title">${type.membership_type_name}</div>
            <div class="membership-type-price">${type.currency} ${type.amount} / ${subscriptionPeriod}</div>
            <div class="membership-type-description">
                ${type.description || 'Standard membership with full benefits'}
            </div>
            
            <!-- Custom Amount Section -->
            <div class="custom-amount-section mt-4" style="display: none;">
                <label class="input-label mb-2">Choose Your Contribution:</label>
                <div class="amount-suggestion-pills mb-3">
                    ${type.suggested_amounts.map(suggestion => 
                        `<button type="button" class="amount-pill px-3 py-1 mr-2 mb-2 border rounded" 
                                data-amount="${suggestion.amount}">
                            ${suggestion.label} (${type.currency} ${suggestion.amount})
                        </button>`
                    ).join('')}
                </div>
                <div class="mt-3">
                    <label class="input-label">Or enter custom amount:</label>
                    <input type="number" class="form-input custom-amount-input mt-1" 
                           min="${type.minimum_amount}" step="0.01" placeholder="Enter amount">
                    <p class="text-sm text-gray-600 mt-1">Minimum: ${type.currency} ${type.minimum_amount}</p>
                </div>
            </div>
            
            <div class="btn-group mt-4">
                <button type="button" class="btn-primary select-membership mr-2">
                    Select Standard
                </button>
                <button type="button" class="btn-secondary toggle-custom">
                    Choose Amount
                </button>
            </div>
            
            <input type="radio" name="membership_type" value="${type.name}" style="display: none;">
        `;
        
        // Bind events for this card
        this.bindMembershipCardEvents(card, type);
        
        return card;
    }
    
    bindMembershipCardEvents(card, type) {
        // Select standard membership
        const selectBtn = card.querySelector('.select-membership');
        selectBtn.addEventListener('click', () => {
            this.selectMembershipType(type, false);
        });
        
        // Toggle custom amount section
        const toggleBtn = card.querySelector('.toggle-custom');
        toggleBtn.addEventListener('click', () => {
            const customSection = card.querySelector('.custom-amount-section');
            
            if (customSection.style.display === 'none') {
                // Hide all other custom sections
                document.querySelectorAll('.custom-amount-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.querySelectorAll('.toggle-custom').forEach(btn => {
                    btn.textContent = 'Choose Amount';
                });
                
                // Show this custom section
                customSection.style.display = 'block';
                toggleBtn.textContent = 'Standard Amount';
                
                // Pre-select standard amount
                const standardAmount = parseFloat(type.amount);
                const standardPill = card.querySelector(`[data-amount="${standardAmount}"]`);
                if (standardPill) {
                    standardPill.click();
                }
            } else {
                customSection.style.display = 'none';
                toggleBtn.textContent = 'Choose Amount';
                this.selectMembershipType(type, false);
            }
        });
        
        // Amount suggestion pills
        card.querySelectorAll('.amount-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                const amount = parseFloat(pill.dataset.amount);
                
                // Update UI
                card.querySelectorAll('.amount-pill').forEach(p => p.classList.remove('bg-accent-500', 'text-white'));
                pill.classList.add('bg-accent-500', 'text-white');
                
                const input = card.querySelector('.custom-amount-input');
                input.value = amount;
                
                this.selectMembershipType(type, true, amount);
            });
        });
        
        // Custom amount input
        const customInput = card.querySelector('.custom-amount-input');
        customInput.addEventListener('input', () => {
            const amount = parseFloat(customInput.value);
            if (!isNaN(amount) && amount >= type.minimum_amount) {
                // Clear pill selection
                card.querySelectorAll('.amount-pill').forEach(p => p.classList.remove('bg-accent-500', 'text-white'));
                this.selectMembershipType(type, true, amount);
            }
        });
    }
    
    renderFallbackMembershipTypes() {
        // Fallback in case API fails
        const fallbackTypes = [
            { name: 'Maandlid', membership_type_name: 'Monthly Member', amount: 5.0, currency: 'EUR', description: 'Monthly membership payment' },
            { name: 'Kwartaallid', membership_type_name: 'Quarterly Member', amount: 15.0, currency: 'EUR', description: 'Quarterly membership payment' }
        ];
        
        this.renderMembershipTypes(fallbackTypes);
    }
    
    selectMembershipType(type, usesCustomAmount = false, customAmount = null) {
        // Remove selection from all cards
        document.querySelectorAll('.membership-type-card').forEach(c => c.classList.remove('selected'));
        
        // Add selection to clicked card
        const card = document.querySelector(`[data-type="${type.name}"]`);
        if (card) {
            card.classList.add('selected');
        }
        
        // Determine final amount
        const finalAmount = usesCustomAmount && customAmount ? customAmount : parseFloat(type.amount);
        
        // Set form values
        document.getElementById('membership_type').value = type.name;
        
        // Store additional data for submission (matching working form)
        this.membershipData = {
            selected_membership_type: type.name,
            membership_amount: finalAmount,
            uses_custom_amount: usesCustomAmount,
            membership_type_details: type
        };
        
        // Set radio button
        const radio = card?.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;
        
        // Update payment summary
        this.updatePaymentSummary({
            ...type,
            amount: finalAmount,
            uses_custom_amount: usesCustomAmount
        });
        
        // Hide membership type error
        const errorElement = document.getElementById('membership_type_error');
        if (errorElement) {
            errorElement.classList.add('hidden');
        }
        
        console.log('Selected membership:', this.membershipData);
    }
    
    setupMembershipSelection() {
        // Chapter suggestion based on postal code
        const postalCodeField = document.getElementById('postal_code');
        if (postalCodeField) {
            postalCodeField.addEventListener('blur', (e) => {
                const postalCode = e.target.value;
                const country = document.getElementById('country').value || 'Netherlands';
                
                if (postalCode && document.getElementById('chapter-selection').style.display !== 'none') {
                    this.suggestChapterFromPostalCode(postalCode, country);
                }
            });
        }
        
        // Accept chapter suggestion
        const acceptButton = document.getElementById('accept-suggestion');
        if (acceptButton) {
            acceptButton.addEventListener('click', () => {
                const suggestedChapter = document.getElementById('suggested-chapter-name').textContent;
                if (suggestedChapter) {
                    document.getElementById('selected_chapter').value = suggestedChapter;
                    document.getElementById('suggested-chapter').style.display = 'none';
                }
            });
        }
    }
    
    setupVolunteerFields() {
        // Show/hide volunteer details based on interest
        const interestedCheckbox = document.getElementById('interested_in_volunteering');
        if (interestedCheckbox) {
            interestedCheckbox.addEventListener('change', (e) => {
                const volunteerDetails = document.getElementById('volunteer-details');
                const volunteerAreas = document.getElementById('volunteer-areas');
                
                if (e.target.checked) {
                    volunteerDetails.style.display = 'block';
                    volunteerAreas.style.display = 'block';
                } else {
                    volunteerDetails.style.display = 'none';
                    volunteerAreas.style.display = 'none';
                }
            });
        }
    }
    
    setupPaymentFields() {
        // Bank details are always shown for payment matching
        const bankDetails = document.getElementById('bank-details');
        const bankDescription = document.getElementById('bank-details-description');
        const ibanField = document.getElementById('iban');
        const accountHolderField = document.getElementById('account_holder_name');
        
        // Always show bank details and make them required
        if (bankDetails) {
            bankDetails.style.display = 'block';
            ibanField.setAttribute('required', '');
            accountHolderField.setAttribute('required', '');
        }
        
        // Update description based on payment method selection
        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'sepa_direct_debit') {
                    bankDescription.textContent = 'Your bank account for automatic membership fee collection.';
                } else {
                    bankDescription.textContent = 'Your bank account details for payment matching and processing.';
                }
            });
        });
    }
    
    suggestChapterFromPostalCode(postalCode, country) {
        console.log('Suggesting chapter for postal code:', postalCode);
        
        fetch('/api/method/verenigingen.api.membership_application.validate_postal_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': frappe.csrf_token || '',
            },
            body: JSON.stringify({
                postal_code: postalCode,
                country: country
            })
        })
        .then(response => response.json())
        .then(result => {
            console.log('Postal code validation result:', result.message);
            
            if (result.message && result.message.suggested_chapters && result.message.suggested_chapters.length > 0) {
                const suggestedChapter = result.message.suggested_chapters[0];
                document.getElementById('suggested-chapter-name').textContent = suggestedChapter.name || suggestedChapter;
                document.getElementById('suggested-chapter').style.display = 'block';
            } else {
                document.getElementById('suggested-chapter').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error validating postal code:', error);
            document.getElementById('suggested-chapter').style.display = 'none';
        });
    }
    
    updatePaymentSummary(membershipType) {
        if (typeof membershipType === 'object') {
            // New format with actual membership type object
            const summary = `${membershipType.currency} ${membershipType.amount}`;
            const element = document.getElementById('payment-summary');
            if (element) {
                element.textContent = `Selected: ${membershipType.membership_type_name} - ${summary}`;
            }
        } else {
            // Fallback for old format
            const fees = {
                'regular': '‚Ç¨25/year',
                'student': '‚Ç¨15/year', 
                'supporter': '‚Ç¨10/year',
                'custom': 'Custom amount/year'
            };
            
            const types = {
                'regular': 'Regular Member',
                'student': 'Student Member',
                'supporter': 'Supporter'
            };
            
            const summaryElement = document.getElementById('payment-summary');
            if (summaryElement && fees[membershipType]) {
                summaryElement.textContent = `${types[membershipType]}: ${fees[membershipType]}`;
            }
        }
    }
    
    validateField(e) {
        const field = e.target;
        const errorElement = document.getElementById(field.name + '_error');
        let isValid = true;
        let errorMessage = '';
        
        // Basic required field validation
        if (field.hasAttribute('required') && !field.value.trim()) {
            isValid = false;
            errorMessage = 'This field is required';
        }
        
        // Specific field validations
        if (isValid && field.value.trim()) {
            switch (field.name) {
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(field.value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid email address';
                    }
                    break;
                    
                case 'mobile_no':
                    if (field.value.trim()) {
                        const phoneRegex = /^[\+]?[0-9\s\-\(\)]{8,}$/;
                        if (!phoneRegex.test(field.value)) {
                            isValid = false;
                            errorMessage = 'Please enter a valid phone number';
                        }
                    }
                    break;
                    
                case 'birth_date':
                    if (field.value) {
                        try {
                            const age = this.calculateAge(field.value);
                            
                            if (age < 16) {
                                isValid = false;
                                errorMessage = 'You must be at least 16 years old to apply for membership';
                            } else if (age > 120) {
                                isValid = false;
                                errorMessage = 'Please enter a valid birth date';
                            }
                            
                            // Show age info when date is entered and valid
                            if (isValid) {
                                this.showAgeInfo(age);
                            }
                        } catch (error) {
                            console.error('Error calculating age:', error);
                            isValid = false;
                            errorMessage = 'Please enter a valid birth date';
                        }
                    }
                    break;
                    
                case 'postal_code':
                    const country = document.getElementById('country').value;
                    if (country === 'Netherlands') {
                        const dutchPostalRegex = /^[1-9][0-9]{3}\s?[A-Z]{2}$/i;
                        if (!dutchPostalRegex.test(field.value)) {
                            isValid = false;
                            errorMessage = 'Please enter a valid Dutch postal code (e.g., 1234 AB)';
                        }
                    }
                    break;
                    
                case 'iban':
                    if (field.hasAttribute('required') || field.value.trim()) {
                        const ibanRegex = /^[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}$/;
                        const cleanIban = field.value.replace(/\s/g, '').toUpperCase();
                        if (!ibanRegex.test(cleanIban)) {
                            isValid = false;
                            errorMessage = 'Please enter a valid IBAN';
                        } else {
                            // Format IBAN nicely
                            field.value = cleanIban.replace(/(.{4})/g, '$1 ').trim();
                        }
                    }
                    break;
                    
                case 'first_name':
                case 'last_name':
                    if (field.value.trim().length < 2) {
                        isValid = false;
                        errorMessage = 'Name must be at least 2 characters long';
                    }
                    break;
                    
                case 'custom_amount':
                    const amount = parseFloat(field.value);
                    if (isNaN(amount) || amount < 10) {
                        isValid = false;
                        errorMessage = 'Custom amount must be at least ‚Ç¨10';
                    } else if (amount > 1000) {
                        isValid = false;
                        errorMessage = 'Custom amount seems unusually high. Please contact us if this is correct.';
                    }
                    break;
            }
        }
        
        // Update field styling and error message
        if (isValid) {
            field.classList.remove('border-red-500');
            field.classList.add('border-green-500');
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        } else {
            field.classList.remove('border-green-500');
            field.classList.add('border-red-500');
            if (errorElement) {
                errorElement.textContent = errorMessage;
                errorElement.classList.remove('hidden');
            }
        }
        
        return isValid;
    }
    
    calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        
        return age;
    }
    
    showAgeInfo(age) {
        const birthDateField = document.getElementById('birth_date');
        let ageInfo = document.getElementById('age-info');
        
        if (!ageInfo) {
            ageInfo = document.createElement('p');
            ageInfo.id = 'age-info';
            ageInfo.className = 'text-sm text-gray-600 mt-1';
            birthDateField.parentElement.appendChild(ageInfo);
        }
        
        // Suggest appropriate membership type based on age
        let suggestion = '';
        if (age <= 25) {
            suggestion = ' (Consider our Student Member option if you\'re a student!)';
        }
        
        ageInfo.textContent = `Age: ${age} years${suggestion}`;
    }
    
    nextStep(e) {
        e.preventDefault();
        
        const isValid = this.validateCurrentStep();
        
        if (isValid) {
            if (this.currentStep < this.totalSteps) {
                this.currentStep++;
                this.updateStep();
            }
        }
    }
    
    prevStep(e) {
        e.preventDefault();
        
        if (this.currentStep > 1) {
            this.currentStep--;
            this.updateStep();
        }
    }
    
    updateStep() {        
        // Hide all steps
        const allSteps = document.querySelectorAll('.form-step');
        allSteps.forEach(step => {
            step.classList.remove('active');
        });
        
        // Show current step
        const currentStepElement = document.querySelector(`.form-step[data-step="${this.currentStep}"]`);
        if (currentStepElement) {
            currentStepElement.classList.add('active');
        } else {
            console.error('Could not find step element for step:', this.currentStep);
        }
        
        // Update progress steps
        document.querySelectorAll('.progress-step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index + 1 === this.currentStep) {
                step.classList.add('active');
            } else if (index + 1 < this.currentStep) {
                step.classList.add('completed');
            }
        });
        
        // Update progress bar
        const progress = (this.currentStep / this.totalSteps) * 100;
        document.getElementById('form-progress').style.width = `${progress}%`;
        
        // Populate confirmation step when reaching step 6
        if (this.currentStep === 6) {
            this.populateConfirmation();
        }
        
        // Show/hide navigation buttons
        const prevBtn = document.getElementById('btn-prev');
        const nextBtn = document.getElementById('btn-next');
        const submitBtn = document.getElementById('btn-submit');
        
        if (this.currentStep === 1) {
            prevBtn.classList.add('hidden');
        } else {
            prevBtn.classList.remove('hidden');
        }
        
        if (this.currentStep === this.totalSteps) {
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
        } else {
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        }
        
        // Scroll to top smoothly
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    validateCurrentStep() {
        const currentStepElement = document.querySelector(`.form-step[data-step="${this.currentStep}"]`);
        if (!currentStepElement) {
            console.error('Could not find current step element');
            return false;
        }
        
        const requiredFields = currentStepElement.querySelectorAll('[required]');
        let isValid = true;
        
        // Basic validation for required fields
        requiredFields.forEach(field => {
            if (field.hasAttribute('required')) {
                const value = field.value?.trim();
                if (!value) {
                    // Show validation error but don't block navigation during testing
                    field.classList.add('border-red-500');
                    field.classList.remove('border-green-500');
                    
                    const errorElement = document.getElementById(field.id + '_error');
                    if (errorElement) {
                        errorElement.classList.remove('hidden');
                        errorElement.textContent = 'This field is required';
                    }
                } else {
                    // Field has value, clear any errors
                    field.classList.remove('border-red-500');
                    field.classList.add('border-green-500');
                    
                    const errorElement = document.getElementById(field.id + '_error');
                    if (errorElement) {
                        errorElement.classList.add('hidden');
                    }
                }
            }
        });
        
        // Special case for membership selection (step 3)
        if (this.currentStep === 3) {
            const membershipType = document.getElementById('membership_type').value;
            if (!membershipType) {
                isValid = false;
                document.getElementById('membership_type_error').classList.remove('hidden');
                console.log('Membership type not selected');
            } else {
                document.getElementById('membership_type_error').classList.add('hidden');
            }
        }
        
        // Temporary: Allow navigation even if validation fails (for testing)
        return true; // Force allow navigation during testing
    }
    
    populateConfirmation() {
        // Personal Information
        const firstName = document.getElementById('first_name').value || '';
        const middleName = document.getElementById('middle_name').value || '';
        const lastName = document.getElementById('last_name').value || '';
        const fullName = [firstName, middleName, lastName].filter(n => n).join(' ');
        
        document.getElementById('confirm-name').textContent = fullName;
        document.getElementById('confirm-email').textContent = document.getElementById('email').value || '';
        document.getElementById('confirm-phone').textContent = document.getElementById('mobile_no').value || 'Not provided';
        
        // Address
        const address = document.getElementById('address_line1').value || '';
        const postalCode = document.getElementById('postal_code').value || '';
        const city = document.getElementById('city').value || '';
        const country = document.getElementById('country').value || '';
        
        document.getElementById('confirm-address').textContent = `${address}, ${postalCode}`;
        document.getElementById('confirm-city').textContent = `${city}, ${country}`;
        
        // Membership
        const membershipType = document.getElementById('membership_type').value;
        const customAmount = document.getElementById('custom_amount').value;
        
        const types = {
            'regular': 'Regular Member (‚Ç¨25/year)',
            'student': 'Student Member (‚Ç¨15/year)',
            'supporter': 'Supporter (‚Ç¨10/year)',
            'custom': `Custom Amount (‚Ç¨${customAmount || '0'}/year)`
        };
        
        document.getElementById('confirm-membership-type').textContent = types[membershipType] || 'Not selected';
        
        // Payment Method
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
        const paymentText = paymentMethod ? 
            (paymentMethod.value === 'sepa_direct_debit' ? 'Direct Debit' : 'Bank Transfer') : 
            'Not selected';
        
        document.getElementById('confirm-payment-method').textContent = paymentText;
        
        // Volunteering
        const volunteering = document.querySelector('input[name="interested_in_volunteering"]:checked');
        const volunteerText = volunteering ? 
            (volunteering.value === 'yes' ? 'Yes, interested in volunteering' : 'Not interested in volunteering') : 
            'Not specified';
        
        document.getElementById('confirm-volunteering').textContent = volunteerText;
    }
    
    autoSave(e) {
        const field = e.target;
        this.formData[field.name] = field.value;
        
        // Save to localStorage
        localStorage.setItem('membership_application_draft_tailwind', JSON.stringify(this.formData));
    }
    
    loadSavedData() {
        const savedData = localStorage.getItem('membership_application_draft_tailwind');
        if (savedData) {
            this.formData = JSON.parse(savedData);
            
            // Populate form fields
            Object.keys(this.formData).forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    field.value = this.formData[fieldName];
                    
                    // Update membership selection if applicable
                    if (fieldName === 'membership_type') {
                        const membershipCard = document.querySelector(`[data-membership="${field.value}"]`);
                        if (membershipCard) {
                            membershipCard.click();
                        }
                    }
                }
            });
        }
    }
    
    async submitForm(e) {
        e.preventDefault();
        
        // Validate all steps
        let allValid = true;
        for (let step = 1; step <= this.totalSteps; step++) {
            this.currentStep = step;
            this.updateStep();
            if (!this.validateCurrentStep()) {
                allValid = false;
                break;
            }
        }
        
        if (!allValid) {
            // Show error message
            this.showMessage('{{ _("Please fill all required fields") }}', 'error');
            return;
        }
        
        // Collect form data
        const formData = new FormData(document.getElementById('membership-application-form'));
        const data = Object.fromEntries(formData.entries());
        
        // Process checkbox arrays (volunteer areas)
        const volunteerAreas = [];
        formData.getAll('volunteer_areas[]').forEach(area => {
            volunteerAreas.push(area);
        });
        data.volunteer_areas = volunteerAreas;
        
        // Add membership selection data (matching working form)
        if (this.membershipData) {
            data.selected_membership_type = this.membershipData.selected_membership_type;
            data.membership_amount = this.membershipData.membership_amount;
            data.uses_custom_amount = this.membershipData.uses_custom_amount;
        }
        
        console.log('Submitting application data:', data);
        
        try {
            // Show loading state
            const submitBtn = document.getElementById('btn-submit');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '{{ _("Submitting...") }}';
            
            // Make actual API call to Frappe backend
            const response = await fetch('/api/method/verenigingen.api.membership_application.submit_application', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Frappe-CSRF-Token': frappe.csrf_token || '',
                },
                body: JSON.stringify({
                    data: {
                        ...data,
                        // Fix payment method values
                        payment_method: data.payment_method === 'sepa_direct_debit' ? 'Direct Debit' : 'Bank Transfer'
                    }
                })
            });
            
            const result = await response.json();
            console.log('API Response:', result);
            
            if (result.message && result.message.success) {
                // Success
                this.showSuccessMessage();
                // Clear saved data
                localStorage.removeItem('membership_application_draft_tailwind');
            } else {
                // Error from API
                throw new Error(result.message?.error || result.error || 'Submission failed');
            }
            
            // Clear saved data
            localStorage.removeItem('membership_application_draft_tailwind');
            
            // Show success message
            this.showSuccessMessage();
            
        } catch (error) {
            console.error('Submission error:', error);
            this.showMessage('{{ _("An error occurred while submitting your application") }}', 'error');
        } finally {
            const submitBtn = document.getElementById('btn-submit');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '{{ _("Submit Application") }}';
        }
    }
    
    showSuccessMessage() {
        // Hide form
        document.getElementById('membership-application-form').style.display = 'none';
        document.querySelector('.progress-container').style.display = 'none';
        
        // Show success message
        document.getElementById('success-message').classList.remove('hidden');
    }
    
    showMessage(message, type = 'info') {
        // Create and show a temporary message
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert-${type === 'error' ? 'danger' : 'info'} mb-4`;
        messageDiv.innerHTML = message;
        
        // Insert at top of form
        const form = document.getElementById('membership-application-form');
        form.insertBefore(messageDiv, form.firstChild);
        
        // Remove after 5 seconds
        setTimeout(() => messageDiv.remove(), 5000);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    new MembershipApplicationTailwind();
});
</script>
{% endblock %}