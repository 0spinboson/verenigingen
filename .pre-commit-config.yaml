# Pre-commit hooks for Verenigingen app
# Install with: pre-commit install

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/)'
      - id: end-of-file-fixer
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/)'
      - id: check-yaml
      - id: check-added-large-files
      - id: check-json
      - id: check-merge-conflict
      - id: debug-statements
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/)'
      - id: check-docstring-first
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/)'

  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
        language_version: python3
        args: ['--line-length=110']
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/)'

  - repo: https://github.com/PyCQA/flake8
    rev: 6.0.0
    hooks:
      - id: flake8
        args: [
          '--max-line-length=120',
          '--max-complexity=20',
          '--extend-ignore=E501,W503,E203,F401,E722,F821,C901,E225'
        ]
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/|.*test.*\.py|.*debug.*\.py)'

  - repo: https://github.com/PyCQA/isort
    rev: 5.12.0
    hooks:
      - id: isort
        args: ['--profile', 'black', '--line-length', '110']
        exclude: '^(scripts/|tests/|debug_utils/|dev_scripts/|integration_tests/|verenigingen/tests/|frontend_tests/)'

  - repo: https://github.com/PyCQA/pylint
    rev: v3.0.3
    hooks:
      - id: pylint
        args: [
          '--rcfile=.pylintrc',
          '--fail-under=7.0',
          '--jobs=0'
        ]
        exclude: '^(node_modules|.git|dist|build|scripts|tests|debug_utils|dev_scripts|integration_tests|verenigingen/tests|frontend_tests)/'

  # Security validation (NEW)
  - repo: https://github.com/PyCQA/bandit
    rev: '1.7.5'
    hooks:
      - id: bandit
        name: üîç Security Linting (Bandit)
        args: ['-r', 'verenigingen/', '--skip', 'B101,B601', '--exclude', 'archived_removal,archived_unused', '--severity-level', 'high']
        pass_filenames: false
        exclude: '^(tests/|scripts/testing/)'

  - repo: local
    hooks:
      # Security validation hooks (TEMPORARILY DISABLED)
      # - id: insecure-api-detector
      #   name: üîí Insecure API Endpoint Detection
      #   description: Detect API endpoints lacking proper security decorators
      #   entry: python scripts/validation/security/insecure_api_detector.py
      #   language: system
      #   files: '^verenigingen/api/.*\.py$'
      #   pass_filenames: true
      #   verbose: true
      #   stages: [pre-commit, pre-push]

      # - id: api-security-validator
      #   name: üõ°Ô∏è  API Security Framework Validation
      #   description: Validate API security framework compliance
      #   entry: python scripts/validation/security/api_security_validator.py
      #   language: system
      #   files: '^verenigingen/api/.*\.py$'
      #   pass_filenames: true
      #   stages: [pre-commit]

      # Original validation hooks (RESTORED)
      - id: run-quick-tests
        name: Run quick validation tests
        entry: python scripts/testing/integration/simple_test.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        verbose: true

      - id: docfield-checker
        name: Legacy field reference checker (fallback)
        entry: python scripts/validation/legacy_field_validator.py
        language: system
        pass_filenames: false
        files: \.py$
        stages: [manual]

      - id: doctype-field-validator
        name: DocType attribute access validation
        entry: python scripts/validation/doctype_field_validator.py --pre-commit --reduced-fp-mode
        language: system
        pass_filenames: false
        files: \.py$
        stages: [pre-commit]
        exclude: '^(tests/|test_|.*_test\.py|debug_|.*_debug\.py|scripts/testing/|scripts/debug/|test_field_validation_gaps\.py)'

      - id: sql-field-validator
        name: SQL query field validation
        entry: python scripts/validation/sql_field_validator_with_confidence.py
        language: system
        pass_filenames: false
        files: \.py$
        stages: [pre-commit]
        exclude: '^(tests/|test_|.*_test\.py|debug_|.*_debug\.py|scripts/testing/|scripts/debug/)'

      - id: frappe-api-validator
        name: Frappe database API field validation
        entry: python scripts/validation/frappe_api_field_validator.py
        language: system
        pass_filenames: false
        files: \.py$
        stages: [pre-commit]
        exclude: '^(tests/|test_|.*_test\.py|debug_|.*_debug\.py|scripts/testing/|scripts/debug/)'

      - id: enhanced-field-validator
        name: Deprecated field validation (pre-push)
        entry: python scripts/validation/deprecated_field_validator.py
        language: system
        pass_filenames: false
        files: '\.(py|html|js)$'
        stages: [pre-push]
        exclude: '^(tests/|test_|.*_test\.py|debug_|.*_debug\.py|scripts/testing/|scripts/debug/|test_field_validation_gaps\.py)'

      - id: template-field-validator
        name: HTML/JavaScript template field validation
        entry: python scripts/validation/template_field_validator.py
        language: system
        pass_filenames: false
        files: '\.(html|js)$'
        stages: [pre-commit]
        exclude: '^(tests/|test_|.*_test\.(html|js)|debug_|.*_debug\.(html|js)|scripts/testing/|scripts/debug/|frontend_tests/|node_modules/)'

      - id: javascript-doctype-validator
        name: JavaScript DocType field validation
        entry: python scripts/validation/javascript_doctype_field_validator.py
        language: system
        pass_filenames: false
        files: '\.js$'
        stages: [pre-push]
        exclude: '^(tests/|test_|.*_test\.js|debug_|.*_debug\.js|scripts/testing/|scripts/debug/|frontend_tests/|node_modules/)'

      - id: eslint
        name: ESLint JavaScript validation
        entry: npx eslint
        language: node
        files: \.js$
        stages: [pre-commit]
        args: [--fix]
        additional_dependencies:
          - eslint@^8.57.0
          - eslint-plugin-security@^1.7.1
          - eslint-plugin-no-unsanitized@^4.0.2
        exclude: '^(node_modules/|archived_unused/|scripts/analysis/|scripts/monitoring/|scripts/performance/|scripts/rollback/|scripts/security/|debug_utils/|dev_scripts/)|\.min\.js$|\.bundle\.js$'

      - id: fast-method-validator
        name: Method call validation
        entry: python scripts/validation/method_call_validator.py
        language: system
        pass_filenames: false
        files: '\.py$'
        stages: [pre-commit]
        exclude: '^(archived_unused/|archived_removal/|scripts/testing/|scripts/debug/|test_field_validation_gaps\.py|.*_test\.py|debug_.*\.py)'

      - id: workspace-validator
        name: Workspace integrity validation
        entry: python scripts/validation/workspace_integrity_validator.py
        language: system
        pass_filenames: false
        files: '^(verenigingen/fixtures/workspace\.json|verenigingen/api/workspace_.*\.py)$'
        stages: [pre-commit]

      - id: comprehensive-validation
        name: Validation suite runner (field + template)
        entry: python scripts/validation/validation_suite_runner.py --quiet
        language: system
        pass_filenames: false
        files: '\.(py|html)$'
        stages: [manual]
        exclude: '^(tests/|test_|.*_test\.py|debug_|.*_debug\.py|scripts/testing/|scripts/debug/)'

      - id: context-aware-validator
        name: Context-aware field validation (high precision)
        entry: python scripts/validation/context_aware_field_validator.py
        language: system
        pass_filenames: false
        files: \.py$
        stages: [manual]

      - id: comprehensive-doctype-validator
        name: Comprehensive DocType validation with SQL patterns
        entry: python scripts/validation/comprehensive_doctype_validator.py
        language: system
        pass_filenames: false
        files: \.py$
        stages: [manual]

      - id: performance-validator
        name: Performance-optimized validation (large codebases)
        entry: python scripts/validation/performance_optimized_validator.py
        language: system
        pass_filenames: false
        files: \.py$
        stages: [manual]

      - id: field-validation-only
        name: Database field validation (fast check)
        entry: python scripts/validation/validation_suite_runner.py --field-only --quiet
        language: system
        pass_filenames: false
        files: '\.py$'
        stages: [pre-push]
        exclude: '^(tests/|test_|.*_test\.py|debug_|.*_debug\.py|scripts/testing/|scripts/debug/)'

      # Pytest Coverage Hook
      - id: pytest-coverage-critical
        name: üìä Pytest Coverage Check (Critical Tests)
        description: Run critical tests with coverage enforcement
        entry: python scripts/testing/pytest_precommit_runner.py
        language: system
        pass_filenames: false
        files: '\.py$'
        exclude: '^(migrations/|fixtures/|scripts/testing/|scripts/debug/|.*_debug\.py|test_.*\.py)'
        stages: [pre-commit]
        verbose: true
        require_serial: true
